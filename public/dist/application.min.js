"use strict";var ApplicationConfiguration=function(){var a="apollo",b=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","ui-rangeSlider","ngAutocomplete","LocalStorageModule","angularMoment","angularFileUpload","angularMoment","gettext","btford.socket-io"],c=function(b){angular.module(b,[]),angular.module(a).requires.push(b)};return{applicationModuleName:a,applicationModuleVendorDependencies:b,registerModule:c}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function(a){a.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),angular.module("gettext").run(["gettextCatalog",function(a){a.setStrings("nl",{"Find your ideal place to live.":"Vind je ideale woonst."})}]),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("rooms"),ApplicationConfiguration.registerModule("search"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("FooterController",["$scope","$rootScope",function(a,b){a.hidden=!1,b.$on("hide_footer",function(){a.hidden=!0})}]),angular.module("core").controller("HeaderController",["$rootScope","$scope","$stateParams","$location","$modal","$http","$interval","Authentication","Menus","Geocoder","Modal","gettextCatalog","Socket","amMoment",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){console.log("changing language to %s",a),l.currentLanguage=a,l.debug=!0,n.changeLanguage(a)}b.authentication=h,b.isCollapsed=!1,b.menu=i.getMenu("topbar"),b.search="",b.searchDetails={},b.unreadMessageCount=0,b.messagesPopoverVisible=!1,b.init=function(){a.language=window.navigator.userLanguage||window.navigator.language,-1!==a.language.indexOf("nl")&&o("nl"),a.$watch("language",function(a,b){a!==b&&o(a)}),h.user&&(m.emit("join",h.user._id),m.on("newMessageCount",function(a){c.inboxId&&c.inboxId===a.inbox||(b.unreadMessageCount=+b.unreadMessageCount+a.count)}),a.$on("inbox_read",function(){b.unreadMessageCount>0&&b.unreadMessageCount--}))},b.toggleCollapsibleMenu=function(){b.isCollapsed=!b.isCollapsed},b.goToSearch=function(){b.searchDetails.geometry?d.path("search/"+b.search.replace(/, /g,"--")).search("lat",b.searchDetails.geometry.location.lat()).search("lng",b.searchDetails.geometry.location.lng()):j.geocodeAddress(b.search).then(function(a){d.path("search/"+a.formattedAddress.replace(/, /g,"--")).search("lat",a.lat).search("lng",a.lng)}),b.searchDetails={}},b.openSignupModal=function(){k.signup()},b.openSigninModal=function(){k.signin()},b.getUnreadMessageCount=function(){h.user&&f({method:"GET",url:"/users/unreadmessages"}).then(function(a){b.unreadMessageCount=a.data})}}]),angular.module("core").controller("HomeController",["$scope","$location","Authentication","Geocoder","Alert","Meta",function(a,b,c,d,e,f){a.authentication=c,a.search="",a.searchDetails={},f.setTitle("Apollo",!0),a.goToSearch=function(){a.searchDetails.geometry?b.path("search/"+a.search.replace(/, /g,"--")).search("lat",a.searchDetails.geometry.location.lat()).search("lng",a.searchDetails.geometry.location.lng()):d.geocodeAddress(a.search).then(function(a){b.path("search/"+a.formattedAddress.replace(/, /g,"--")).search("lat",a.lat).search("lng",a.lng)}),a.searchDetails={}}}]),angular.module("core").directive("backImg",[function(){return{restriction:"A",scope:{imgProvider:"@",imgLink:"@"},link:function(a,b){var c="";a.imgProvider&&a.imgLink&&(c="cloudinary"===a.imgProvider?"http://res.cloudinary.com/dv8yfamzc/image/upload/"+a.imgLink+".png":a.imgLink,b.css({"background-image":"url("+c+")"}))}}}]),angular.module("core").directive("datePicker",["$window",function(a){return{restrict:"A",scope:{startDate:"@",dateModel:"=",minDate:"="},link:function(b,c,d){function e(a){b.dateModel=new Date(a),b.$apply()}b.appendToELement=void 0!==d.appendElement;var f,g={firstDay:1,format:"DD/MM/YYYY",onSelect:e};b.appendToELement?(f=new a.Pikaday(g),c.html(f.el)):(g.field=c[0],f=new a.Pikaday(g)),b.$watch("startDate",function(a,b){a!==b&&f.setDate(new Date(a),!0)}),b.$watch("minDate",function(){var a=new Date(b.minDate);f.setMinDate(a),a>b.dateModel&&f.setDate(a,!0)})}}}]),angular.module("core").directive("onRepeatDone",[function(){return{restriction:"A",link:function(a,b,c){a.$last&&a.$emit(c.onRepeatDone||"repeat_done",b)}}}]),angular.module("core").directive("shareButton",[function(){return{restriction:"A",link:function(a,b,c){var d=c.shareButton;console.log(c),"facebook"===d?b.click(function(a){window.open("//www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=436"),a.preventDefault()}):"twitter"===d?b.click(function(a){window.open("//twitter.com/share?url="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=448"),a.preventDefault()}):"pinterest"===d?b.click(function(a){window.open("//pinterest.com/pin/create/button/?url=S"+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=436"),a.preventDefault()}):"google"===d&&b.click(function(a){window.open("//plus.google.com/share?url="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=359"),a.preventDefault()})}}}]),angular.module("core").directive("statisticsChart",["$window",function(a){return{restriction:"E",require:"ngModel",scope:{model:"=ngModel"},link:function(b,c,d){function e(a,b){var c=h.time.day.range(a,b),d=[];return c.forEach(function(a){var b={date:a};b[i]=0,d.push(b)}),d}function f(a,b){b.forEach(function(b){a.forEach(function(a){a.date=new Date(a.date),a.date.getTime()===b.date.getTime()&&(b[i]=a[i])})})}function g(a){var b={top:20,right:20,bottom:30,left:50},d=800-b.left-b.right,e=200-b.top-b.bottom,f=h.time.scale().range([0,d]),g=h.scale.linear().range([e,0]),j=h.svg.axis().scale(f).orient("bottom"),k=h.svg.axis().scale(g).orient("left").tickSize(-d).ticks(5),l=h.svg.line().x(function(a){return f(new Date(a.date))}).y(function(a){return g(+a[i])}).interpolate("monotone"),m=h.select(c[0]).append("svg").attr("width",d+b.left+b.right).attr("height",e+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");f.domain(h.extent(a,function(a){return new Date(a.date)})),g.domain(h.extent(a,function(a){return a[i]})),m.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(j),m.append("g").attr("class","y axis").call(k).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(i),m.append("path").datum(a).attr("class","line").attr("d",l),m.append("g").selectAll("circle").data(a).enter().append("circle").attr("class","data-point").attr("cx",function(a){return f(new Date(a.date))}).attr("cy",function(a){return g(+a[i])}).attr("r",3.5).attr("tooltip","JHDFISDHFSF")}var h=a.d3,i=d.value,j=new Date;j=j.setDate(j.getDate()-30);var k=e(j,new Date);b.$watch("model",function(a){a.length>0&&(f(a,k),g(k))})}}}]),angular.module("core").directive("videoBackground",["$window",function(){return{restrict:"A",link:function(a,b,c){b.vide(c.videoPath,{volume:1,playbackRate:1,muted:!0,loop:!0,autoplay:!0,position:"50% 50%"}),a.$on("$destroy",function(){var a=b.data("vide");a.destroy()})}}}]),angular.module("core").filter("parseUrl",[function(){var a=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,b=/(^|[^\/])(www\.[\S]+(\b|$))/gim,c=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;return function(d){return angular.forEach(d.match(a),function(){d=d.replace(a,'<a href="$1" target="_blank">$1</a>')}),angular.forEach(d.match(b),function(){d=d.replace(b,'$1<a href="http://$2" target="_blank">$2</a>')}),angular.forEach(d.match(c),function(){d=d.replace(c,'<a href="mailto:$1">$1</a>')}),d}}]),angular.module("core").service("Alert",["$rootScope","$timeout",function(a,b){a.alerts=[];var c=this;this.add=function(d,e,f){a.alerts.push({type:d,msg:e,close:function(){c.closeAlert(this)}}),f&&b(function(){c.closeAlert(this)},f)},this.closeAlert=function(b){return this.closeAlertIdx(a.alerts.indexOf(b))},this.closeAlertIdx=function(b){return a.alerts.splice(b,1)}}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["user"],this.menus={};var a=function(a){if(!a)return this.isPublic;for(var b in a.roles)for(var c in this.roles)if(this.roles[c]===a.roles[b])return!0;return!1};this.validateMenuExistance=function(a){if(a&&a.length){if(this.menus[a])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(a){return this.validateMenuExistance(a),this.menus[a]},this.addMenu=function(b,c,d){return this.menus[b]={isPublic:c||!1,roles:d||this.defaultRoles,items:[],shouldRender:a},this.menus[b]},this.removeMenu=function(a){this.validateMenuExistance(a),delete this.menus[a]},this.addMenuItem=function(b,c,d,e,f,g){return this.validateMenuExistance(b),this.menus[b].items.push({title:c,link:d,uiRoute:e||"/"+d,isPublic:f||this.menus[b].isPublic,roles:g||this.defaultRoles,shouldRender:a}),this.menus[b]},this.removeMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)this.menus[a].items[c].link===b&&this.menus[a].items.splice(c,1);return this.menus[a]},this.addMenu("topbar")}]),angular.module("core").service("Meta",["$rootScope","$window",function(a){this.setTitle=function(b,c){var d=c?b:"Apollo - "+b;a.title=d},this.setDescription=function(b){a.description=b}}]),angular.module("core").service("Modal",["$modal","$location",function(a,b){this.signup=function(){var a={templateUrl:"modules/users/views/signup.client.view.html",controller:"AuthenticationController",windowClass:"small"};return this.showModal(a,{})},this.signin=function(){var a=b.path();console.log(a);var c={templateUrl:"modules/users/views/signin.client.view.html",controller:"AuthenticationController",windowClass:"small",resolve:{redirectTo:function(){return a}}};return this.showModal(c,{})},this.contact=function(a){var b={templateUrl:"modules/rooms/views/modals/contact-modal.client.view.html",resolve:{contactInfo:function(){return a}}};return this.showModal(b,{})},this.reservation=function(a){var b={templateUrl:"modules/rooms/views/modals/reservation-modal.client.view.html",controller:"ModalController",resolve:{modalContent:function(){return a}}};return this.showModal(b,{})},this.changeAddress=function(a){var b={templateUrl:"modules/rooms/views/modals/change-address-modal.client.view.html",controller:"ManageRoomController",resolve:{addressDetails:function(){return a}}};return this.showModal(b,{})},this.confirm=function(){var a={templateUrl:"modules/rooms/views/modals/confirm-modal.client.view.html",windowClass:"small"};return this.showModal(a,{})};var c={backdrop:!0,keyboard:!0,modalFade:!0,templateUrl:"modules/core/views/modal.client.view.html"},d={closeButtonText:"Close",actionButtonText:"OK",headerText:"Proceed?",bodyText:"Perform this action?"};this.showModal=function(a,b){return a||(a={}),this.show(a,b)},this.show=function(b,e){var f={},g={};return angular.extend(f,c,b),angular.extend(g,d,e),f.controller||(f.controller=function(a,b){a.modalOptions=g,a.modalOptions.ok=function(a){b.close(a)},a.modalOptions.close=function(){b.dismiss("cancel")}}),a.open(f).result}}]),angular.module("core").factory("Socket",["$window","socketFactory",function(a,b){var c=a.io.connect("http://localhost:3001");return b({ioSocket:c})}]),angular.module("core").service("Statistics",["$http","localStorageService",function(a,b){function c(b,c){a.post("/statistics/"+b+"/aggregate",{type:c})}var d=!1;this.aggregate=function(a,e){if(d){var f=b.get("viewedRooms")||[];-1===f.indexOf(a)&&(c(a,e),f.push(a)),b.set("viewedRooms",f)}else c(a,e)}}]),angular.module("rooms").run(["Menus",function(){}]),angular.module("rooms").config(["$stateProvider",function(a){a.state("createRoom",{url:"/rooms/new",templateUrl:"modules/rooms/views/create-room.client.view.html"}).state("viewRoom",{url:"/l/:roomId/:city/:title",templateUrl:"modules/rooms/views/view-room.client.view.html"}).state("editRoom",{url:"/rooms/:roomId/edit/:nav",templateUrl:"modules/rooms/views/edit-room.client.view.html"})}]),angular.module("rooms").controller("CreateRoomController",["$scope","$location","Authentication","Rooms","Modal","Geocoder","Meta",function(a,b,c,d,e,f,g){function h(b){f.geocodeAddress(b).then(function(b){b.accuracy<7||(a.addressDetails={street:b.street+" "+b.streetNumber,city:b.city,country:b.country,geo:[b.lng,b.lat]},a.create())})}a.authentication=c,a.createForm={address:"",roomType:""},a.autocompleteOptions={country:"be",watchEnter:!0},a.addressDetails=null,a.creationStep=1,a.busy=!1,a.init=function(){g.setTitle("Advertentie toevoegen"),c.user&&(a.creationStep=2)},a.create=function(){if(a.createForm.roomType){if(null===a.addressDetails)return void h(a.createForm.address);var c=new d({location:{street:a.addressDetails.street,city:a.addressDetails.city,country:a.addressDetails.country},loc:{type:"Point",coordinates:a.addressDetails.geo},classification:a.createForm.roomType});c.$save(function(a){b.path("rooms/"+a._id+"/edit/")},function(b){a.error=b.data.message}),a.createForm.address=""}},a.openSingupModal=function(){e.signup().then(function(){a.creationStep=2})},a.openSinginModal=function(){e.signin().then(function(){a.creationStep=2})}}]),angular.module("rooms").controller("ManageRoomController",["$scope","$stateParams","$location","Authentication","Rooms","Geocoder","$timeout","$window","Amenity","$upload","$http","Modal","Alert","Meta",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b){a.busy=!0,j.upload({url:"rooms/"+a.room._id+"/upload",data:{index:a.room.pictures.length},file:b}).success(function(b){a.room.pictures.push({provider:"cloudinary",link:b.id}),a.busy=!1}).error(function(){a.busy=!1,m.add("danger","There was a problem adding this picture, try again later.",5e3)})}function p(b,c){a.busy=!0,c.forEach(function(b){k.post("/rooms/"+a.room._id+"/upload",{link:b.link,index:a.room.pictures.length}).success(function(b){a.room.pictures.push({provider:"cloudinary",link:b.id}),a.busy=!1}).error(function(){a.busy=!1,m.add("danger","There was a problem adding this picture, try again later.",5e3)})})}function q(){k.get("/statistics/"+a.room._id+"/lastmonth").success(function(b){a.statisticsData=b})}a.authentication=d,a.createForm={address:"",roomType:""},a.autocompleteOptions={country:"be",watchEnter:!0},a.addressDetails=null,a.busy=!1,a.nav="general",a.amenities=i.list(),a.errors=[],a.newAddress="",a.newAddressDetails={},a.statisticsData=[],a.init=function(){n.setTitle("Advertentie aanpassen"),b.nav&&(a.nav=b.nav),b.roomId||c.path("/"),a.room=e.get({roomId:b.roomId},a.watchForUpdates),a.$on("dropbox_chosen",p)},a.watchForUpdates=function(){function b(){return{visible:a.room.visible,pictures:a.room.pictures,leaseType:a.room.leaseType,available:a.room.available,loc:a.room.loc,location:a.room.location,info:a.room.info,amenities:a.room.amenities,price:a.room.price,surface:a.room.surface}}a.$broadcast("room_loaded",a.room),a.checkRoomCompleteness(),q();var c=h._.debounce(a.update,800);a.$watch(b,function(b,d){b===d||a.busy||(a.checkRoomCompleteness(),c())},!0)},a.update=function(){a.busy=!0,console.log("updating"),console.log(a.room),a.room.$update(function(){a.busy=!1},function(b){a.error=b.data.message,a.busy=!1})},a.onImageSelect=function(a){a.length>0&&o(a[0])},a.removeImage=function(b){a.busy=!0,k.post("/rooms/"+a.room._id+"/removepicture",{index:b}).success(function(){a.room.pictures.splice(b,1),a.busy=!1}).error(function(){a.busy=!1})},a.toggleAmenitySelection=function(b){var c=a.room.amenities.indexOf(b);c>-1?a.room.amenities.splice(c,1):a.room.amenities.push(b)},a.isAmenityChecked=function(b){return a.room.amenities?-1!==a.room.amenities.indexOf(b):!1},a.setTab=function(b){a.nav=b,c.path("rooms/"+a.room._id+"/edit/"+b)},a.checkRoomCompleteness=function(){var b=[];a.room.info.title&&""!==a.room.info.title||b.push("general"),a.room.price.base&&0!==a.room.price.base||b.push("costs"),!a.room.available.immediately&&(!a.room.available.from||!a.room.available.till||new Date(a.room.available.till))<new Date&&b.push("availability"),console.log(b),a.errors=b},a.tabHasError=function(b){return-1!==a.errors.indexOf(b)},a.openAddressModal=function(){var b={newAddress:a.newAddress,newAddressDetails:a.newAddressDetails};l.changeAddress(b).then(function(b){a.room.location={street:b.street+" "+b.streetNumber,city:b.city,country:b.country},a.room.loc={type:"Point",coordinates:b.geo},a.$broadcast("room_loaded",a.room)})},a.setRoomVisible=function(){0===a.errors.length&&(a.room.visible=!0,c.path(a.room.url))},a.visibilityText=function(a){return a?"online":"offline"},a.deleteRoom=function(){l.confirm().then(function(){a.room.$remove(function(){c.path("/dashboard/rooms")})})}}]),angular.module("rooms").controller("ModalController",["$rootScope","$scope","$modalInstance","modalContent",function(a,b,c,d){b.modalContent=d}]),angular.module("rooms").controller("RoomsController",["$rootScope","$scope","$stateParams","$http","Authentication","Rooms","Amenity","Modal","Alert","localStorageService","Statistics","Meta",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){d.post("/rooms/"+b.room._id+"/favorite").success(function(){var a=e.user.favorites.indexOf(b.room._id);-1===a?(k.aggregate(b.room._id,"favorites"),e.user.favorites.push(b.room._id),i.add("success","Added to favorites!",3e3)):e.user.favorites.splice(a,1)}).error(function(){i.add("danger","There was a problem adding this favorite, try again later.",5e3)})}function n(a){k.aggregate(b.room._id,"messages"),d.post("/rooms/"+b.room._id+"/message",{message:a}).success(function(){i.add("success","Your message has been sent!",5e3)}).error(function(){i.add("danger","There was a problem sending your message, try again later.",5e3)})}function o(a){k.aggregate(b.room._id,"reservations"),d.post("/rooms/"+b.room._id+"/message",{message:b.appointmentDate.getTime(),messageType:"reservation"}).success(function(){a?n(a):i.add("success","Your reservation has been sent!",5e3)}).error(function(){i.add("danger","There was a problem sending your message, try again later.",5e3)})}function p(){l.setTitle(b.room.info.title+" - "+b.room.location.city,!0),l.setDescription(b.room.info.description),k.aggregate(b.room._id,"views"),b.otherRooms=f.getRoomsOfSameLocation({roomId:b.room._id}),b.$broadcast("room_loaded",b.room),0===b.room.pictures.length&&b.$emit("pictures_rendered")}b.authentication=e,b.contactInfo={appointmentDate:new Date,name:"",email:""},b.appointmentDate=new Date,b.otherRooms=[],b.amenities=g.list(),b.isOverlay=!1,b.init=function(){b.findOne()},b.findOne=function(){b.room=f.get({roomId:c.roomId},p)},b.isAmenityChecked=function(a,c){return b.room.amenities?-1!==a.amenities.indexOf(c.value):!1},b.openReservationModal=function(){e.user?h.reservation(b.appointmentDate).then(o):h.signup().then(function(){h.reservation(b.appointmentDate).then(o)})},b.openContactModal=function(){e.user?h.contact(b.contactInfo).then(n):h.signup().then(function(){h.contact(b.contactInfo).then(n)})},b.toggleFavorite=function(){e.user?m():h.signup().then(function(){m()})},b.isInfavorites=function(){return e.user?-1!==e.user.favorites.indexOf(b.room._id):!1},b.closeOverlay=function(){a.$broadcast("close_overlay")},b.isOverlay=function(){return c.isOverlay},b.visibilityText=function(a){return a?"online":"offline"},b.updateRoom=function(){b.room.$update()}}]),angular.module("rooms").directive("addressLookup",["$window","Geocoder",function(a,b){return{restrict:"A",scope:{resultObject:"="},require:"^form",link:function(c,d,e,f){function g(a){b.geocodeAddress(a).then(function(a){d.val(a.formattedAddress),c.resultObject={street:a.street,streetNumber:a.streetNumber,city:a.city,country:a.country,geo:[a.lng,a.lat]},i()})}function h(a){for(var b="",d="",e="",f="",g=0;g<a.address_components.length;g++){var h=a.address_components[g].types[0];switch(h){case"street_number":b=a.address_components[g].long_name;break;case"route":d=a.address_components[g].long_name;break;case"locality":e=a.address_components[g].long_name;break;case"country":f=a.address_components[g].long_name}}c.resultObject={street:d,streetNumber:b,city:e,country:f,geo:[a.geometry.location.lng(),a.geometry.location.lat()]},i()}function i(){c.resultObject.street&&""!==c.resultObject.street?f.$setValidity("noStreet",!0):f.$setValidity("noStreet",!1),c.resultObject.streetNumber&&""!==c.resultObject.streetNumber?f.$setValidity("noStreetNumber",!0):f.$setValidity("noStreetNumber",!1)}f.$setValidity("",!1);var j=new a.google.maps.places.Autocomplete(d[0],{types:["geocode"]});a.google.maps.event.addListener(j,"place_changed",function(){var a=j.getPlace();a.address_components?h(a):g(a.name)})}}}]),angular.module("rooms").directive("owlCarousel",["$window",function(a){return{restrict:"A",link:function(b,c,d){var e,f={autoPlay:5e3,slideSpeed:200,paginationSpeed:600,rewindSpeed:800,stopOnHover:!0,navigation:!0,pagination:"true"===d.owlPagination,rewindNav:!0,singleItem:!0,autoHeight:!1,lazyLoad:!1,mouseDrag:!1,navigationText:['<i class="icon-left-open-mini"></i>','<i class="icon-right-open-mini"></i>']},g=a.$(c);b.$on("pictures_rendered",function(){e=g.owlCarousel(f).data("owlCarousel")}),b.$on("$destroy",function(){e&&e.destroy()})}}}]),angular.module("rooms").directive("checkAddress",["$parse",function(){return{restrict:"A",link:function(a){a.createRoomForm.$setValidity("input",!1),a.$watch("autoCompleteDetails",function(b){if(b){a.createRoomForm.$setValidity("input",!0);for(var c="",d="",e="",f="",g=0;g<b.address_components.length;g++){var h=b.address_components[g].types[0];switch(h){case"street_number":c=b.address_components[g].long_name;break;case"route":d=b.address_components[g].long_name;break;case"locality":e=b.address_components[g].long_name;break;case"country":f=b.address_components[g].long_name}}""===d?a.createRoomForm.$setValidity("noStreet",!1):a.createRoomForm.$setValidity("noStreet",!0),""===c?a.createRoomForm.$setValidity("noStreetNumber",!1):a.createRoomForm.$setValidity("noStreetNumber",!0),a.createRoomForm.$valid&&(a.addressDetails={street:d+" "+c,city:e,country:f,geo:[b.geometry.location.lng(),b.geometry.location.lat()]})}})}}}]),angular.module("core").directive("dropboxChooser",["$window",function(a){return{restrict:"A",scope:{chooserSuccess:"&"},link:function(b,c){var d={success:function(a){b.$emit("dropbox_chosen",a)},linkType:"direct",multiselect:!1,extensions:["images"]};c.click(function(){a.Dropbox.choose(d)})}}}]),angular.module("core").directive("limitText",[function(){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel"},link:function(a,b,c){a.$watch("model",function(b,d){b!==d&&(a.model=a.model.substring(0,c.limitText))})}}}]),angular.module("rooms").directive("roomMap",["$window",function(a){return{template:'<div id="map" class="map-canvas"></div>',restrict:"A",link:function(b,c){function d(a){return"room"===a?"lodging":"appartment"===a?"commercial":"building"}var e=null,f=a.L.mapbox.map(c[0],"defreek.j27p0821",{zoomControl:!1});b.$on("room_loaded",function(b,c){f.setView([c.loc.coordinates[1],c.loc.coordinates[0]],15),f.dragging.disable(),f.touchZoom.disable(),f.doubleClickZoom.disable(),f.scrollWheelZoom.disable(),f.tap&&f.tap.disable(),e&&e.clearLayers(),e=a.L.mapbox.featureLayer({type:"Feature",geometry:c.loc,properties:{"marker-size":"medium","marker-color":"#f44","marker-symbol":d(c.classification)}}).addTo(f)}),b.$on("$destroy",function(){f.remove()})}}}]),angular.module("rooms").directive("streetView",["$window",function(a){return{scope:{center:"=mapCenter"},template:"<div></div>",restrict:"A",link:function(b,c){b.$on("room_loaded",function(b,d){function e(a,b,c){a.setPosition(b),a.setPov({heading:c,zoom:1,pitch:0}),a.setVisible(!0)}var f=d.loc.coordinates,g=new a.google.maps.LatLng(f[1],f[0]),h=new a.google.maps.StreetViewPanorama(c[0],{zoomControl:!1,position:g,pov:{heading:0,pitch:0,zoom:1}}),i=new a.google.maps.StreetViewService,j=50;i.getPanoramaByLocation(g,j,function(b,c){if(c===a.google.maps.StreetViewStatus.OK){var d=g;g=b.location.latLng;var f=a.google.maps.geometry.spherical.computeHeading(g,d);e(h,g,f)}})})}}}]),angular.module("rooms").factory("Amenity",[function(){return{list:function(){return[{name:"TV",value:"television"},{name:"Internet",value:"internet"},{name:"Terras",value:"terrace"},{name:"Auto garage",value:"parking"},{name:"Fietsstalling parking",value:"bicycleParking"},{name:"Dubbel glas",value:"doubleGlass"},{name:"Bemeubeld",value:"furnished"},{name:"Aparte badkamer",value:"seperateBathroom"},{name:"Aparte keuken",value:"seperateKitchen"},{name:"Huisdieren toegelaten",value:"pets"},{name:"Domicilie verplicht",value:"domicile"}]}}}]),angular.module("rooms").factory("Rooms",["$resource",function(a){return a("rooms/:roomId",{roomId:"@_id"},{update:{method:"PUT"},getMyRooms:{method:"GET",url:"/myrooms",isArray:!0},getRoomsOfSameLocation:{method:"GET",url:"rooms/:roomId/same",isArray:!0}})}]),angular.module("search").config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("search",{url:"/search/:address",templateUrl:"modules/search/views/search.client.view.html"}).state("search.overlay",{url:"/rooms/:roomId/:isOverlay",templateUrl:"modules/rooms/views/view-room.client.view.html"}),b.deferIntercept()}]).run(["$rootScope","$urlRouter","$location","$state",function(a,b,c,d){a.$on("$locationChangeSuccess",function(a,c,e){a.preventDefault(),console.log(d.current.name),-1!==e.indexOf("/search/")&&-1!==c.indexOf("/l/")?console.log("skipping route"):b.sync(),b.listen()})}]),angular.module("search").controller("SearchController",["$rootScope","$scope","$timeout","$location","$state","$stateParams","Geocoder","Rooms","$window","Amenity","Authentication","Users","localStorageService","Meta",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){a.lat&&a.lng&&(b.filter.location=[parseFloat(a.lng),parseFloat(a.lat)]),a.proximity&&(b.filter.proximity=a.proximity),a.minPrice&&(b.filter.minPrice=+a.price),a.maxPrice&&(b.filter.maxPrice=+a.maxPrice),a.roomType&&(b.filter.roomType=a.roomType),a.size&&(b.filter.size=+a.size),a.amneties&&(b.filter.amneties=a.amneties)}function p(a){g.geocodeAddress(a).then(function(a){b.mapCenter=[a.lng,a.lat],b.filter.proximity=a.proximity})}function q(){e.transitionTo("search",f,{reload:!1,location:!1}),t&&(d.url(t),t=null),n.setTitle("Zoeken in "+f.address),b.selectedRoomId=null,b.isOverLayOpen=!1}function r(){e.transitionTo("search.overlay",f,{reload:!1,location:!1}),b.$broadcast("close_marker_popups"),b.isOverLayOpen=!0}b.mapCenter=[4.35171,50.85034],b.mapZoom=13,b.fetchOnMapChange=!0,b.filter={location:[],proximity:3600,roomType:[],minPrice:0,maxPrice:2e3,size:null,amenities:[]},b.results=[],b.amenities=j.list(),b.selectedRoomId=null,b.isOverLayOpen=!1;var s=m.get("viewedRooms")||[],t=null;b.init=function(){function c(a){var b=Math.floor(Math.log(20088e3/a)/Math.log(2));return b>19&&(b=19),0>b&&(b=0),b}n.setTitle("Zoeken in "+f.address);var e=d.search();e.lat&&e.lng||!f.address?e.lat&&e.lng?(o(e),b.mapCenter=b.filter.location,b.mapZoom=c(b.filter.proximity)):b.mapZoom=9:p(f.address),f.roomId&&(b.selectedRoomId=f.roomId,r()),b.fetchRooms(),a.$on("close_overlay",q),b.$watch("filter",function(a,c){a!==c&&b.searchFunction()},!0)},b.mapChangedEvent=function(a){b.filter.proximity=a.proximity/2,b.filter.location=[a.lng,a.lat],d.search("lat",a.lat).search("lng",a.lng).search("proximity",b.filter.proximity),c(function(){b.$apply()})},b.fetchRooms=function(){h.query(b.filter,function(a){var c=b.results,d=a,e=c.map(function(a){return a._id}),f=d.map(function(a){return a._id}),g=i._.difference(e,f),h=i._.difference(f,e);c=c.filter(function(a){return!i._.contains(g,a._id)}),d.forEach(function(a){i._.contains(h,a._id)&&c.push(a)}),b.results=c})},b.toggleAmenitySelection=function(a){var c=b.filter.amenities.indexOf(a);c>-1?b.filter.amenities.splice(c,1):b.filter.amenities.push(a)},b.saveQueryAsUserAlert=function(){if(k.user){var a=angular.copy(b.filter);k.user.alerts.push({filters:a});var c=new l(k.user);c.$update()}},b.selectRoom=function(a,c){b.selectedRoomId&&b.selectedRoomId===a?(b.selectedRoomId=null,q()):(b.selectedRoomId=a,i._.extend(f,{roomId:a,isOverlay:!0}),t=d.url(),d.url(c),r(),-1===s.indexOf(a)&&s.push(a))},b.hasSeenRoom=function(a){return-1!==s.indexOf(a)},b.openRoomPopup=function(a){b.$broadcast("open_marker_popup",a)},b.getRoomTypeIcon=function(a){return"room"===a?"lodging":"appartment"===a?"commercial":"building"},b.setRoomType=function(a){return"all"===a?[]:[a]},b.searchFunction=i._.debounce(b.fetchRooms,400)}]),angular.module("search").directive("checkboxGroup",["$window",function(a){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel"},link:function(b,c){var d=c.children("button");d.bind("click",function(c){var d=a.$(c.currentTarget),e=d.attr("data-val"),f=b.model.indexOf(e);d.hasClass("active")?(-1!==f&&b.model.splice(f,1),d.removeClass("active")):(-1===f&&b.model.push(e),d.addClass("active")),c.stopPropagation()})}}}]),angular.module("search").directive("googleMap",["$window",function(a){return{scope:{markers:"=mapMarkers",center:"=mapCenter",zoom:"=mapZoom",options:"=mapOptions",changedEvent:"=mapChanged"},template:'<div id="map" class="map-canvas"></div>',restrict:"A",link:function(b,c){function d(){var b=h.getBounds(),c=b.getSouthWest(),d=b.getNorthEast();return a.google.maps.geometry.spherical.computeDistanceBetween(c,d)}function e(){f.forEach(function(a){a.setMap(null)}),f=[]}var f=[],g={center:new a.google.maps.LatLng(b.center[1],b.center[0]),zoom:b.zoom,disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{style:a.google.maps.ZoomControlStyle.SMALL},mapTypeId:a.google.maps.MapTypeId.ROADMAP},h=new a.google.maps.Map(c[0],g);b.changedEvent&&(h.addListener("dragend",function(){b.changedEvent({lng:h.getCenter().lng(),lat:h.getCenter().lat(),proximity:d()})}),h.addListener("zoom_changed",function(){b.changedEvent({lng:h.getCenter().lng(),lat:h.getCenter().lat(),proximity:d()})})),b.$watchCollection("markers",function(b,c){b!==c&&(e(),b.forEach(function(b){var c=new a.google.maps.Marker({map:h,position:new a.google.maps.LatLng(b.loc.coordinates[1],b.loc.coordinates[0]),icon:new a.google.maps.MarkerImage("/modules/rooms/img/map-marker2.svg")});f.push(c)}),console.log(f.length))}),b.$watch("center",function(b,c){b!==c&&h.setCenter(new a.google.maps.LatLng(b[1],b[0]))}),b.$watch("zoom",function(a,b){a!==b&&h.setZoom(a)})}}}]),angular.module("search").directive("mapboxMap",["$compile","$q","$window","$http","$timeout",function(a,b,c,d,e){var f;return{restrict:"E",transclude:!0,replace:!0,scope:{center:"=mapCenter",zoom:"=mapZoom",changedEvent:"=mapChanged",preventPopups:"=",selectRoom:"="},template:'<div class="map-canvas" ng-transclude></div>',link:function(b,g,h){function i(a){b.markers.forEach(function(b){b.roomId===a&&b.openPopup()})}function j(){var a=b.map.getBounds(),c=a.getNorthWest(),d=a.getSouthEast();return Math.floor(c.distanceTo(d))}function k(){var a=b.map.getCenter(),e={client_id:"4I5SHYQHG4OXY2ZCCRTFPNYFVK0U0G4NPLIBKLWGM2SWLPVY",client_secret:"11YEGLXWQBXX4KERSY2CXLMC4E3C2X021DGZLXVVMK0KRWJZ",ll:a.lat+","+a.lng,radius:j(),v:"20140701",categoryId:"4bf58dd8d48988d1ae941735"};d({url:"https://api.foursquare.com/v2/venues/search",method:"GET",params:e}).success(function(a){a.response.venues.forEach(function(a){{var b=c.L.latLng(a.location.lat,a.location.lng);c.L.marker(b,{icon:c.L.divIcon({className:"maki-icon college"})}).bindPopup('<a target="_blank" href="https://foursquare.com/v/'+a.id+'">'+a.name+"</a>").addTo(m)
}})})}b.map=c.L.mapbox.map(g[0],"defreek.j27p0821").setView([b.center[1],b.center[0]],b.zoom),f.resolve(b.map),b.isClusteringMarkers=void 0!==h.clusterMarkers;var l=void 0!==h.scaleToFit;b.fitMapToMarkers=function(){if(l){var a=new c.L.featureGroup(b.markers);b.map.fitBounds(a.getBounds())}};var m=(new c.L.featureGroup).addTo(b.map);b.changedEvent&&b.map.on("moveend",function(){var a=b.map.getCenter();b.changedEvent({lng:a.lng,lat:a.lat,proximity:j()})}),b.$on("open_marker_popup",function(a,c){b.preventPopups||i(c)}),b.$on("close_marker_popups",function(){b.markers.forEach(function(a){a.closePopup()})}),b.map.on("popupopen",function(){var c=angular.element(document.getElementsByClassName("leaflet-popup-content"));a(c)(b),e(function(){b.$apply()})}),b.$on("$destroy",function(){b.map.remove()}),k()},controller:function(a){a.markers=[],a.featureLayers=[],f=b.defer(),a.getMap=this.getMap=function(){return f.promise},c.L.MarkerClusterGroup&&(a.clusterGroup=new c.L.MarkerClusterGroup({showCoverageOnHover:!1}),this.getMap().then(function(b){b.addLayer(a.clusterGroup)})),this.$scope=a}}}]),angular.module("search").directive("mapboxMarker",["$compile","$window","$http",function(a,b){var c={navy:"#001f3f",blue:"#0074d9",aqua:"#7fdbff",teal:"#39cccc",olive:"#3d9970",green:"#2ecc40",lime:"#01ff70",yellow:"#ffdc00",orange:"#ff851b",red:"#ff4136",fuchsia:"#f012be",purple:"#b10dc9",maroon:"#85144b",white:"white",silver:"#dddddd",gray:"#aaaaaa",black:"#111111"};return{restrict:"E",require:"^mapboxMap",transclude:!0,scope:!0,replace:!0,link:function(d,e,f,g,h){function i(a,b){var d=b||{};return a.size&&(d["marker-size"]=a.size),a.color&&(d["marker-color"]="#"===a.color[0]?a.color:c[a.color]||a.color),a.icon&&(d["marker-symbol"]=a.icon),d}var j,k={draggable:void 0!==f.draggable},l=i(f),m=function(a,c,d,e,f){e=e||{};var h=b.L.mapbox.marker.style({properties:f},[c.lat,c.lng]);return d&&d.length>0&&(h.bindPopup(d,{closeButton:!1,minWidth:320}),h.roomId=c.roomId),g.$scope.isClusteringMarkers&&e.excludeFromClustering!==!0?g.$scope.clusterGroup.addLayer(h):h.addTo(a),e.draggable&&h.dragging.enable(),g.$scope.markers.push(h),h},n=function(a,b,c,d){d=i(d,{"marker-color":"#000","marker-symbol":"star"}),c.excludeFromClustering=!0,a.on("locationfound",function(b){j=m(a,[b.latlng.lat,b.latlng.lng],null,c,d)}),a.locate()};g.getMap().then(function(b){setTimeout(function(){for(var c="",i=h(d,function(){}),o=0;o<i.length;o++)void 0!==i[o].outerHTML&&(c+=i[o].outerHTML);if(void 0!==f.currentLocation)n(b,null,k,l);else{if(c){var p=angular.element(c);a(p)(d),d.$$phase||d.$digest();var q="";for(o=0;o<p.length;o++)q+=p[o].outerHTML;j=m(b,f,q,k,l)}else j=m(b,f,null,k,l);e.bind("$destroy",function(){g.$scope.isClusteringMarkers?g.$scope.clusterGroup.removeLayer(j):b.removeLayer(j)})}},0)})}}}]),angular.module("search").directive("radioGroup",["$window","$timeout",function(a,b){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel",outputFunction:"="},link:function(c,d){function e(a){c.model=c.outputFunction?c.outputFunction(a):a,b(function(){c.$apply()})}var f=d.children("button"),g=d.children("button.active");e(g.attr("data-val")),f.bind("click",function(b){var c=a.$(b.currentTarget);c.hasClass("active")||(f.removeClass("active"),c.addClass("active")),e(c.attr("data-val")),b.stopPropagation()})}}}]),angular.module("search").directive("rangeSlidera",["$window",function(a){return{restrict:"A",scope:{start:"@",step:"@",end:"@",callback:"@",margin:"@",ngModel:"=",ngFrom:"=",ngTo:"="},link:function(b,c){var d,e,f,g,h;return g=a.$(c),d=b.callback?b.callback:"slide",null!==b.ngFrom&&null!==b.ngTo?(e=null,h=null,g.noUiSlider({start:[b.ngFrom||b.start,b.ngTo||b.end],step:parseFloat(b.step||1),connect:!0,margin:parseFloat(b.margin||0),range:{min:[parseFloat(b.start)],max:[parseFloat(b.end)]}}),g.on(d,function(){var a=g.val(),c=a[0],d=a[1];return e=parseFloat(c),h=parseFloat(d),b.$apply(function(){return b.ngFrom=e,b.ngTo=h,h})}),b.$watch("ngFrom",function(a){return a!==e?g.val([a,null]):void 0}),b.$watch("ngTo",function(a){return a!==h?g.val([null,a]):void 0})):(f=null,g.noUiSlider({start:[b.ngModel||b.start],step:parseFloat(b.step||1),range:{min:[parseFloat(b.start)],max:[parseFloat(b.end)]}}),g.on(d,function(){return f=parseFloat(g.val()),b.$apply(function(){return b.ngModel=f,f})}),b.$watch("ngModel",function(a){return a!==f?g.val(a):void 0}))}}}]),angular.module("core").factory("Geocoder",["localStorageService","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.get("locations")?a.get("locations"):{},f=[],g=250,h=function(){var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address},function(i,j){if(j===google.maps.GeocoderStatus.OK){for(var k={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address,accuracy:i[0].address_components.length},l=0;l<i[0].address_components.length;l++){var m=i[0].address_components[l].types[0];switch(m){case"street_number":k.streetNumber=i[0].address_components[l].long_name;break;case"route":k.street=i[0].address_components[l].long_name;break;case"locality":k.city=i[0].address_components[l].long_name;break;case"country":k.country=i[0].address_components[l].long_name}}e[b.address]=k,a.set("locations",e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var n=f[0];n.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{geocodeAddress:function(a){var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]),angular.module("users").config(["$httpProvider",function(a){a.interceptors.push(["$q","$location","Authentication",function(a,b,c){return{responseError:function(d){switch(d.status){case 401:c.user=null,b.path("signin");break;case 403:}return a.reject(d)}}}])}]),angular.module("users").config(["$stateProvider",function(a){a.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/signin.client.view.html"}).state("forgot",{url:"/forgot",templateUrl:"modules/users/views/forgot.client.view.html"}).state("reset",{url:"/reset/:token",templateUrl:"modules/users/views/reset.client.view.html"}).state("dashboard",{url:"/dashboard/:nav",templateUrl:"modules/users/views/dashboard.client.view.html"}).state("viewInbox",{url:"/dashboard/messages/:inboxId",templateUrl:"modules/users/views/inbox.client.view.html",reloadOnSearch:!1}).state("favorites",{url:"/users/:userId/favorites",templateUrl:"modules/users/views/favorites.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$stateParams","$http","$location","$q","Authentication","Modal",function(a,b,c,d,e,f,g){a.authentication=f,a.busy=!1,a.authentication.user&&d.path("/"),a.signup=function(b){var f=e.defer();a.busy=!0,c.post("/auth/signup",a.credentials).success(function(c){return a.authentication.user=c,a.$close&&a.$close(),d.path(b||"/"),f.resolve(),a.busy=!1,f.promise}).error(function(b){return a.error=b.message,f.reject(),a.busy=!1,f.promise})},a.signin=function(b){var f=e.defer();a.busy=!0,c.post("/auth/signin",a.credentials).success(function(c){return a.authentication.user=c,a.$close&&a.$close(),d.path(b||"/"),f.resolve(),a.busy=!1,f.promise}).error(function(b){return a.error=b.message,f.reject(),a.busy=!1,f.promise})},a.forgot=function(){a.success=a.error=null,a.busy=!0,c.post("/auth/forgot",a.credentials).success(function(b){a.credentials=null,a.success=b.message,a.busy=!1}).error(function(b){a.credentials=null,a.error=b.message,a.busy=!1})},a.reset=function(){a.success=a.error=null,a.busy=!0,c.post("/auth/reset/"+b.token,a.passwordDetails).success(function(b){a.success=b.message,a.passwordDetails=null,a.busy=!1}).error(function(b){a.error=b.message,a.busy=!1})},a.openSignupModal=function(){a.$dismiss&&a.$dismiss(),g.signup()},a.openSigninModal=function(){a.$dismiss&&a.$dismiss(),g.signin()}}]),angular.module("users").controller("DashboardController",["$scope","$stateParams","$location","Rooms","Authentication","Meta",function(a,b,c,d,e,f){a.authentication=e,a.nav="rooms",a.init=function(){f.setTitle("Dashboard"),b.nav&&(a.nav=b.nav)},a.getMyRooms=function(){a.myrooms=d.getMyRooms()},a.setTab=function(b){a.nav=b,c.path("dashboard/"+b)},a.goToRoom=function(a){c.path("rooms/"+a)},a.visibilityText=function(a){return a?"online":"offline"},a.updateRoom=function(a){console.log(a.visible),a.$update()}}]),angular.module("users").controller("FavoritesController",["$scope","$http","$location","$stateParams","Authentication","Meta",function(a,b,c,d,e,f){function g(){b.get("/users/"+a.user._id+"/favorites").success(function(b){a.favorites=b,a.busy=!1}).error(function(){a.busy=!1})}a.authentication=e,a.favorites=[],a.busy=!1,a.init=function(){b.get("/users/"+d.userId).success(function(b){a.user=b,f.setTitle("Wishlist van "+a.user.displayName),g()})}}]),angular.module("users").controller("InboxController",["$rootScope","$scope","$location","$http","$stateParams","Inbox","Authentication","Socket",function(a,b,c,d,e,f,g,h){function i(a){a.messages.forEach(function(a){a.sender!==g.user._id&&(a.isRead=!0)}),a.$update()}b.authentication=g,b.newMessage="",b.busy=!1,b.init=function(){b.findOne(e.inboxId),b.inbox.$promise.then(function(a){h.emit("join",a._id)}),b.$on("$destroy",function(){h.emit("leave",b.inbox._id)}),h.on("newMessage",function(a){b.inbox.messages.push(a)})},b.list=function(){b.inboxes=f.query()},b.findOne=function(c){b.inboxes=f.query(),b.inbox=f.get({inboxId:c},function(c){b.hasUnreadMessages(c)&&(i(c),a.$broadcast("inbox_read"))})},b.sendMessage=function(){b.newMessage&&""!==b.newMessage&&(b.busy=!0,d.post("/inbox/"+b.inbox._id+"/sendmessage",{message:b.newMessage}).success(function(a){b.busy=!1,b.newMessage="",b.inbox=a}).error(function(){b.busy=!1}))},b.isMessageOwner=function(a){return a.sender===g.user._id},b.showInbox=function(a){b.findOne(a),c.path("dashboard/messages/"+a)},b.getUserPicture=function(a){var b=a.sender._id===g.user._id?a.roomOwner:a.sender,c="";return"local"===b.provider?c="/modules/core/img/default-user-icon.png":"google"===b.provider?c=b.providerData.picture:"facebook"===b.provider&&(c="http://graph.facebook.com/"+b.providerData.id+"/picture?type=normal"),{"background-image":"url("+c+")"}},b.getLastMessage=function(a){return a.messages[a.messages.length-1]},b.hasUnreadMessages=function(a){for(var b=0;b<a.messages.length;b++){var c=a.messages[b];if(c.sender!==g.user._id&&!c.isRead)return!0}return!1}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","$stateParams","Users","Authentication",function(a,b,c,d,e,f){a.user=f.user,a.busy=!1,a.nav="info",a.user||c.path("/"),a.hasConnectedAdditionalSocialAccounts=function(){for(var b in a.user.additionalProvidersData)return!0;return!1},a.isConnectedSocialAccount=function(b){return a.user.provider===b||a.user.additionalProvidersData&&a.user.additionalProvidersData[b]},a.removeUserSocialAccount=function(c){a.success=a.error=null,b.delete("/users/accounts",{params:{provider:c}}).success(function(b){a.success=!0,a.user=f.user=b}).error(function(b){a.error=b.message})},a.updateUserProfile=function(){a.success=a.error=null;var b=new e(a.user);b.$update(function(b){a.success=!0,f.user=b},function(b){a.error=b.data.message})},a.changeUserPassword=function(){a.success=a.error=null,b.post("/users/password",a.passwordDetails).success(function(){a.success=!0,a.passwordDetails=null}).error(function(b){a.error=b.message})}}]),angular.module("users").directive("scrollBottom",["$timeout",function(a){return{require:"ngModel",scope:{model:"=ngModel"},restrict:"A",link:function(b,c){function d(){e.scrollTop=e.scrollHeight}var e=c[0];b.$parent.$on("messages_rendered",function(){a(function(){d()},100)}),b.$watch("model",function(a){a&&d()})}}}]),angular.module("core").directive("userPicture",[function(){return{restriction:"A",scope:{userModel:"="},link:function(a,b){function c(a){return"google"===a.provider?a.providerData.picture:"facebook"===a.provider?"http://graph.facebook.com/"+a.providerData.id+"/picture?type=normal":"/modules/core/img/default-user-icon.png"}a.$watch("userModel",function(a){a&&b.css({"background-image":"url("+c(a)+")"})})}}}]),angular.module("users").factory("Authentication",[function(){var a=this;return a._data={user:window.user},a._data}]),angular.module("users").factory("Inbox",["$resource",function(a){return a("inbox/:inboxId",{inboxId:"@_id"},{update:{method:"PUT"},sendMessage:{method:"POST",url:"inbox/:inboxId/sendmessage"}})}]),angular.module("users").factory("Users",["$resource",function(a){return a("users",{},{update:{method:"PUT"}})}]);
"use strict";var ApplicationConfiguration=function(){var applicationModuleName="apollo",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","ui-rangeSlider","ngAutocomplete","LocalStorageModule","angularMoment","angularFileUpload","angularMoment","gettext","btford.socket-io","once","angularPayments"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),angular.module("gettext").run(["gettextCatalog",function(gettextCatalog){gettextCatalog.setStrings("en",{"Contacteer ons!":"Contact us!","Hulp nodig?":"Need Help?","Vind je ideale woonst.":"Find your ideal place to live.","© 2014 APOLLO. Alle rechten voorbehouden.":"© 2014 APOLLO. All rights reserved."})}]),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("rooms"),ApplicationConfiguration.registerModule("search"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$stateProvider","$urlRouterProvider","$locationProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"}).state("pricing",{url:"/pricing",params:{upgrade:{value:null}},templateUrl:"modules/core/views/pricing.client.view.html"}).state("about",{url:"/about",templateUrl:"modules/core/views/about.client.view.html"})}]),angular.module("core").controller("FooterController",["$scope","$rootScope",function($scope,$rootScope){$scope.hidden=!1,$rootScope.$on("hide_footer",function(){$scope.hidden=!0})}]),angular.module("core").controller("HeaderController",["$rootScope","$scope","$stateParams","$location","$modal","$http","$interval","Authentication","Menus","Geocoder","Modal","gettextCatalog","Socket","amMoment","$state",function($rootScope,$scope,$stateParams,$location,$modal,$http,$interval,Authentication,Menus,Geocoder,Modal,gettextCatalog,Socket,amMoment,$state){function changeLocation(address,lat,lng){$location.path("search/"+address).search("lat",lat).search("lng",lng)}function setLanguage(language,reload){console.log("changing language to %s",language),gettextCatalog.setCurrentLanguage(language),amMoment.changeLanguage(language),reload&&$state.reload()}$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.search="",$scope.searchDetails={},$scope.unreadMessageCount=0,$scope.messagesPopoverVisible=!1,$scope.init=function(){$rootScope.language=window.navigator.userLanguage||window.navigator.language,-1!==$rootScope.language.indexOf("nl")&&setLanguage("nl",!1),$rootScope.$watch("language",function(newVal,oldVal){newVal!==oldVal&&setLanguage(newVal,!0)}),Authentication.user&&(Socket.emit("join",Authentication.user._id),Socket.on("newMessageCount",function(response){$stateParams.inboxId&&$stateParams.inboxId===response.inbox||($scope.unreadMessageCount=+$scope.unreadMessageCount+response.count)}),$rootScope.$on("inbox_read",function(){$scope.unreadMessageCount>0&&$scope.unreadMessageCount--}))},$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.goToSearch=function(){$scope.searchDetails.geometry?changeLocation($scope.search.replace(/, /g,"--"),$scope.searchDetails.geometry.location.lat(),$scope.searchDetails.geometry.location.lng()):Geocoder.geocodeAddress($scope.search).then(function(result){changeLocation(result.formattedAddress.replace(/, /g,"--"),result.lat,result.lng)}),$scope.searchDetails={}},$scope.openSignupModal=function(){Modal.signup()},$scope.openSigninModal=function(){Modal.signin()},$scope.getUnreadMessageCount=function(){Authentication.user&&$http({method:"GET",url:"/users/unreadmessages"}).then(function(result){$scope.unreadMessageCount=result.data})}}]),angular.module("core").controller("HomeController",["$scope","$location","Authentication","Geocoder","Alert","Meta",function($scope,$location,Authentication,Geocoder,Alert,Meta){function changeLocation(address,lat,lng){$location.path("search/"+address).search("lat",lat).search("lng",lng)}$scope.authentication=Authentication,$scope.search="",$scope.searchDetails={},Meta.setTitle("Apollo",!0),$scope.goToSearch=function(){$scope.searchDetails.geometry?changeLocation($scope.search.replace(/, /g,"--"),$scope.searchDetails.geometry.location.lat(),$scope.searchDetails.geometry.location.lng()):Geocoder.geocodeAddress($scope.search).then(function(result){changeLocation(result.formattedAddress.replace(/, /g,"--"),result.lat,result.lng)}),$scope.searchDetails={}}}]),angular.module("rooms").controller("ModalPaymentController",["$rootScope","$scope","$http","$modalInstance","options","Alert",function($rootScope,$scope,$http,$modalInstance,options,Alert){function saveSubscription(plan,card,couponCode){$http.post("/subscription/choose",{plan:plan,card:card,couponCode:couponCode}).success(function(response){$modalInstance.close(response),$scope.busy=!1}).error(function(){$scope.busy=!1,$modalInstance.dismiss({error:!0})})}$scope.subscriptionPlan=options.subscriptionPlan,$scope.busy=!1,$scope.submitPayment=function(status,response){$scope.busy=!0,response.error?($scope.busy=!1,Alert.add("danger","Er is iets misgelopen met het updaten van je tariefplan, probeer later opnieuw.",5e3)):saveSubscription(options.plan,response.id,options.couponCode)}}]),angular.module("core").controller("PricingController",["$scope","$location","$stateParams","Authentication","Alert","Meta","$http","Modal","Enforcer",function($scope,$location,$stateParams,Authentication,Alert,Meta,$http,Modal,Enforcer){function saveSubscription(plan,couponCode){$http.post("/subscription/choose",{plan:plan,couponCode:couponCode}).success(function(response){Authentication.user=response,Alert.add("success","Je tariefplan is geupdatet!",5e3),$scope.busy=!1}).error(function(){Alert.add("danger","SAVE Er is iets misgelopen met het updaten van je tariefplan, probeer later opnieuw.",5e3),$scope.busy=!1})}$scope.authentication=Authentication,$scope.busy=!1,$scope.couponCode=null,Meta.setTitle("Upgraden"),$scope.init=function(){$scope.upgrade=$stateParams.upgrade},$scope.choosePlan=function(plan){$scope.busy=!0,Enforcer.do(function(){Authentication.user&&!Authentication.user.customerToken?Modal.payment({plan:plan,couponCode:$scope.couponCode}).then(function(response){Authentication.user=response,Alert.add("success","Je tariefplan is geupdatet!",5e3),$scope.busy=!1},function(result){result.error&&Alert.add("danger","CHOOSE Er is iets misgelopen met het updaten van je tariefplan, probeer later opnieuw.",5e3),$scope.busy=!1}):saveSubscription(plan,$scope.couponCode)})},$scope.isCurrentPlan=function(plan){return Authentication.user?Authentication.user.subscriptionPlan===plan:!1}}]),angular.module("core").directive("animateElement",["$window",function($window){return{restriction:"A",link:function(scope,element){var delayTime,animationClass="fadeInUp";element.css({opacity:"0"}),element.waypoint(function(){delayTime+=100,$window.$(this).delay(delayTime).queue(function(next){$window.$(this).toggleClass("animated"),$window.$(this).toggleClass(animationClass),delayTime=0,next()})},{offset:"90%",triggerOnce:!0})}}}]),angular.module("core").directive("backImg",[function(){return{restriction:"A",scope:{imgProvider:"@",imgLink:"@"},link:function(scope,element){var url="";scope.imgProvider&&scope.imgLink&&(url="cloudinary"===scope.imgProvider?"http://res.cloudinary.com/dv8yfamzc/image/upload/"+scope.imgLink+".png":scope.imgLink,element.css({"background-image":"url("+url+")"}))}}}]),angular.module("core").directive("datePicker",["$window",function($window){return{restrict:"A",scope:{startDate:"@",dateModel:"=",minDate:"="},link:function(scope,element,attrs){function selectDate(date){scope.dateModel=new Date(date),scope.$apply()}scope.appendToELement=void 0!==attrs.appendElement;var picker,options={firstDay:1,format:"DD/MM/YYYY",onSelect:selectDate};scope.appendToELement?(picker=new $window.Pikaday(options),element.html(picker.el)):(options.field=element[0],picker=new $window.Pikaday(options)),scope.$watch("startDate",function(newVal,oldVal){newVal!==oldVal&&picker.setDate(new Date(newVal),!0)}),scope.$watch("minDate",function(){var min=new Date(scope.minDate);picker.setMinDate(min),min>scope.dateModel&&picker.setDate(min,!0)})}}}]),angular.module("core").directive("onRepeatDone",[function(){return{restriction:"A",link:function($scope,element,attributes){$scope.$last&&$scope.$emit(attributes.onRepeatDone||"repeat_done",element)}}}]),angular.module("core").directive("shareButton",[function(){return{restriction:"A",link:function(scope,element,attrs){var site=attrs.shareButton;"facebook"===site?element.click(function(e){window.open("//www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=436"),e.preventDefault()}):"twitter"===site?element.click(function(e){window.open("//twitter.com/share?url="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=448"),e.preventDefault()}):"pinterest"===site?element.click(function(e){window.open("//pinterest.com/pin/create/button/?url=S"+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=436"),e.preventDefault()}):"google"===site&&element.click(function(e){window.open("//plus.google.com/share?url="+encodeURIComponent(location.href),"facebook-share-dialog","width=626,height=359"),e.preventDefault()})}}}]),angular.module("core").directive("statisticsChart",["$window",function($window){return{restriction:"E",require:"ngModel",scope:{model:"=ngModel"},link:function(scope,element,attrs){function getValue(value){return value?value:0}function generateDateRange(start,stop){var dateArray=d3.time.day.range(start,stop),newData=[];return dateArray.forEach(function(value){var obj={date:value};obj[dataAttribute]=0,newData.push(obj)}),newData}function interpolateDataInRange(data,range,aggregate){range.forEach(function(rangeObject){for(var i=0;i<data.length;i++){var dataObject=data[i];dataObject.date=new Date(dataObject.date),dataObject.date.getTime()===rangeObject.date.getTime()&&(rangeObject[dataAttribute]=0!==i&&aggregate?getValue(data[i-1][dataAttribute])+getValue(dataObject[dataAttribute]):getValue(dataObject[dataAttribute]))}})}function drawChart(data){var margin={top:20,right:30,bottom:30,left:30},width=element.parent().outerWidth()-margin.left-margin.right-55,height=200-margin.top-margin.bottom,x=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("left").tickSize(-width).ticks(5).tickFormat(d3.format("d")),keyAccessor=function(d){return new Date(d.date)},valueAccessor=function(d){return+d[dataAttribute]},line=d3.svg.line().x(function(d){return x(keyAccessor(d))}).y(function(d){return y(valueAccessor(d))}).interpolate("monotone"),svg=d3.select(element[0]).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");x.domain(d3.extent(data,keyAccessor)),y.domain(d3.extent(data,valueAccessor)),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("class","y axis").call(yAxis),svg.append("path").datum(data).attr("class","line").attr("d",line),svg.append("g").selectAll("circle").data(data).enter().append("circle").attr("class","data-point").attr("cx",function(d){return x(keyAccessor(d))}).attr("cy",function(d){return y(valueAccessor(d))}).attr("r",3.5).attr("tooltip","JHDFISDHFSF")}var d3=$window.d3,dataAttribute=attrs.value,startDate=new Date;startDate=startDate.setDate(startDate.getDate()-30);var range=generateDateRange(startDate,new Date);scope.$watch("model",function(newValue){newValue.length>0&&(interpolateDataInRange(newValue,range,attrs.aggregate),drawChart(range))})}}}]),angular.module("core").directive("videoBackground",["$window",function(){return{restrict:"A",link:function(scope,element,attrs){element.vide(attrs.videoPath,{volume:1,playbackRate:1,muted:!0,loop:!0,autoplay:!0,position:"50% 50%"}),scope.$on("$destroy",function(){var instance=element.data("vide");instance.destroy()})}}}]),angular.module("core").directive("backgroundVideo",["$window",function($window){return{template:'<video id="backgroundVideo" autoplay preload type="" src=""></video><video id="stagingVideo" autoplay preload type="" src=""></video>',restrict:"E",link:function(scope,element){function shuffle(){for(var i=clips.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)),temp=clips[i];clips[i]=clips[j],clips[j]=temp}}function buildInitialVideo(){return settings.videoContainer[0].canPlayType("video/webm")?(settings.supportedType=".webm",settings.videoContainer.attr("type","video/webm;codecs='vp8'")):(settings.supportedType=".mp4",settings.videoContainer.attr("type","video/mp4;codecs='avc1.42E01E, mp4a.40.2'")),shuffle(),settings.videoContainer.attr("src","/modules/core/img/video/"+clips[0][0]+settings.supportedType),settings.videoContainer[0].load(),settings.stagingContainer.attr("src","/modules/core/img/video/"+clips[1][0]+settings.supportedType),settings.stagingContainer[0].load(),settings.stagingContainer[0].pause(),videoTimer=window.setTimeout(function(){console.log("looping"),loop()},clips[0][1]),!0}function loop(){videoTimer=null;var nextClip=clips[1][0],currentTime=clips[1][1];clips[currentClip+1]?(nextClip=clips[currentClip+1][0],currentTime=clips[currentClip][1]):(currentClip=1,nextClip=clips[1][0],currentTime=clips[clips.length-1][1]),0===settings.videoContainer.css("opacity")?(settings.videoContainer[0].play(),settings.videoContainer.animate({opacity:1},150,function(){settings.stagingContainer.animate({opacity:0},0),settings.stagingContainer.attr("src","/modules/core/img/video/"+nextClip+settings.supportedType),settings.stagingContainer[0].load(),settings.stagingContainer[0].pause()})):(settings.stagingContainer[0].play(),settings.stagingContainer.animate({opacity:1},150,function(){settings.videoContainer.animate({opacity:0},0),settings.videoContainer.attr("src","/modules/core/img/video/"+nextClip+settings.supportedType),settings.videoContainer[0].load(),settings.videoContainer[0].pause()})),currentClip++,videoTimer=window.setTimeout(function(){loop()},currentTime)}var videoTimer=null,clips=[["bikefar",4900],["house1",2900],["jonnyskateboard",5900],["kidshouse",1900],["leahdog",4900],["majesticdog",4900],["trackingdriveway",4900]],settings={videoContainer:element.find("#backgroundVideo"),stagingContainer:element.find("#stagingVideo")},currentClip=2;buildInitialVideo(),loop()}}}]),angular.module("core").filter("parseUrl",[function(){var replacePattern1=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,replacePattern2=/(^|[^\/])(www\.[\S]+(\b|$))/gim,replacePattern3=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;return function(text){return angular.forEach(text.match(replacePattern1),function(){text=text.replace(replacePattern1,'<a href="$1" target="_blank">$1</a>')}),angular.forEach(text.match(replacePattern2),function(){text=text.replace(replacePattern2,'$1<a href="http://$2" target="_blank">$2</a>')}),angular.forEach(text.match(replacePattern3),function(){text=text.replace(replacePattern3,'<a href="mailto:$1">$1</a>')}),text}}]),angular.module("core").service("Alert",["$rootScope","$timeout",function($rootScope,$timeout){$rootScope.alerts=[];var self=this;this.add=function(type,msg,timeout){$rootScope.alerts.push({type:type,msg:msg,close:function(){self.closeAlert(this)}}),timeout&&$timeout(function(){self.closeAlert(this)},timeout)},this.closeAlert=function(alert){return this.closeAlertIdx($rootScope.alerts.indexOf(alert))},this.closeAlertIdx=function(index){return $rootScope.alerts.splice(index,1)}}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["user"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:isPublic||this.menus[menuId].isPublic,roles:roles||this.defaultRoles,shouldRender:shouldRender}),this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("core").service("Meta",["$rootScope","$window",function($rootScope){this.setTitle=function(text,replace){var title=replace?text:"Apollo - "+text;$rootScope.title=title},this.setDescription=function(text){$rootScope.description=text}}]),angular.module("core").service("Modal",["$modal","$location",function($modal){this.signup=function(){var options={templateUrl:"modules/users/views/modals/signup-modal.client.view.html",controller:"AuthenticationController",windowClass:"small"};return this.showModal(options,{})},this.signin=function(){var options={templateUrl:"modules/users/views/modals/signin-modal.client.view.html",controller:"AuthenticationController",windowClass:"small"};return this.showModal(options,{})},this.contact=function(info){var options={templateUrl:"modules/rooms/views/modals/contact-modal.client.view.html",resolve:{contactInfo:function(){return info}}};return this.showModal(options,{})},this.reservation=function(info){var options={templateUrl:"modules/rooms/views/modals/reservation-modal.client.view.html",controller:"ModalController",resolve:{modalContent:function(){return info}}};return this.showModal(options,{})},this.changeAddress=function(addressDetails){var options={templateUrl:"modules/rooms/views/modals/change-address-modal.client.view.html",controller:"ManageRoomController",resolve:{addressDetails:function(){return addressDetails}}};return this.showModal(options,{})},this.confirm=function(){var options={templateUrl:"modules/rooms/views/modals/confirm-modal.client.view.html",windowClass:"small"};return this.showModal(options,{})},this.payment=function(paymentOptions){var options={templateUrl:"modules/core/views/modals/payment-modal.client.view.html",controller:"ModalPaymentController",resolve:{options:function(){return paymentOptions}}};return this.showModal(options,{})};var modalDefaults={backdrop:!0,keyboard:!0,modalFade:!0,templateUrl:"modules/core/views/modal.client.view.html"},modalOptions={closeButtonText:"Close",actionButtonText:"OK",headerText:"Proceed?",bodyText:"Perform this action?"};this.showModal=function(customModalDefaults,customModalOptions){return customModalDefaults||(customModalDefaults={}),this.show(customModalDefaults,customModalOptions)},this.show=function(customModalDefaults,customModalOptions){var tempModalDefaults={},tempModalOptions={};return angular.extend(tempModalDefaults,modalDefaults,customModalDefaults),angular.extend(tempModalOptions,modalOptions,customModalOptions),tempModalDefaults.controller||(tempModalDefaults.controller=function($scope,$modalInstance){$scope.modalOptions=tempModalOptions,$scope.modalOptions.ok=function(result){$modalInstance.close(result)},$scope.modalOptions.close=function(){$modalInstance.dismiss("cancel")}}),$modal.open(tempModalDefaults).result}}]),angular.module("core").factory("Socket",["$window","socketFactory",function($window,socketFactory){return socketFactory()}]),angular.module("core").service("Statistics",["$http","localStorageService",function($http,localStorageService){function postStatistic(roomId,type){$http.post("/statistics/"+roomId+"/aggregate",{type:type})}var uniqueViews=!1;this.aggregate=function(roomId,type){if(uniqueViews){var seenRooms=localStorageService.get("viewedRooms")||[];-1===seenRooms.indexOf(roomId)&&(postStatistic(roomId,type),seenRooms.push(roomId)),localStorageService.set("viewedRooms",seenRooms)}else postStatistic(roomId,type)}}]),angular.module("rooms").config(["$stateProvider",function($stateProvider){$stateProvider.state("createRoom",{url:"/rooms/new",templateUrl:"modules/rooms/views/create-room.client.view.html"}).state("viewRoom",{url:"/l/:roomId/:city/:title",templateUrl:"modules/rooms/views/view-room.client.view.html"}).state("editRoom",{url:"/rooms/:roomId/edit/:nav",templateUrl:"modules/rooms/views/edit-room.client.view.html"}).state("analytics",{url:"/rooms/:roomId/analytics",templateUrl:"modules/rooms/views/analytics.client.view.html"}).state("notFound",{url:"/rooms/notfound",templateUrl:"modules/rooms/views/not-found.client.view.html"})}]),angular.module("rooms").controller("AnalyticsController",["$rootScope","$scope","$http","$stateParams","Authentication","Rooms","Meta",function($rootScope,$scope,$http,$stateParams,Authentication,Rooms,Meta){function getStatisticsData(){$http.get("/statistics/"+$scope.room._id+"/lastmonth").success(function(response){console.log(response),$scope.statisticsData=response})}$scope.authentication=Authentication,$scope.statisticsData=[],Meta.setTitle("Analytics"),$scope.init=function(){$scope.findOne()},$scope.findOne=function(){$scope.room=Rooms.get({roomId:$stateParams.roomId},getStatisticsData)}}]),angular.module("rooms").controller("CreateRoomController",["$scope","$location","$state","Authentication","Rooms","Modal","Geocoder","Meta","$http",function($scope,$location,$state,Authentication,Rooms,Modal,Geocoder,Meta,$http){function doSearchLookup(address){Geocoder.geocodeAddress(address).then(function(result){result.accuracy<7||($scope.addressDetails={street:result.street+" "+result.streetNumber,city:result.city,country:result.country,geo:[result.lng,result.lat]},$scope.create())})}function checkUserRoomCount(){$http.get("/roomcount").success(function(){$scope.allowed=!0}).error(function(){$state.transitionTo("pricing",{upgrade:!0})})}$scope.authentication=Authentication,$scope.createForm={address:"",roomType:""},$scope.autocompleteOptions={country:"be",watchEnter:!0},$scope.addressDetails=null,$scope.creationStep=1,$scope.busy=!1,$scope.allowed=!1,$scope.init=function(){Meta.setTitle("Advertentie toevoegen"),Authentication.user?($scope.creationStep=2,checkUserRoomCount()):$scope.allowed=!0},$scope.create=function(){if($scope.createForm.roomType){if(null===$scope.addressDetails)return void doSearchLookup($scope.createForm.address);var room=new Rooms({location:{street:$scope.addressDetails.street,city:$scope.addressDetails.city,country:$scope.addressDetails.country},loc:{type:"Point",coordinates:$scope.addressDetails.geo},classification:$scope.createForm.roomType});room.$save(function(response){$location.path("rooms/"+response._id+"/edit/")},function(errorResponse){$scope.error=errorResponse.data.message}),$scope.createForm.address=""}},$scope.openSingupModal=function(){Modal.signup().then(function(){$scope.creationStep=2})},$scope.openSinginModal=function(){Modal.signin().then(function(){$scope.creationStep=2})}}]),angular.module("rooms").controller("ManageRoomController",["$scope","$stateParams","$location","Authentication","Rooms","Geocoder","$timeout","$window","Amenity","$upload","$http","Modal","Alert","Meta",function($scope,$stateParams,$location,Authentication,Rooms,Geocoder,$timeout,$window,Amenity,$upload,$http,Modal,Alert,Meta){function uploadImage(image){$scope.busy=!0,$upload.upload({url:"rooms/"+$scope.room._id+"/upload",data:{index:$scope.room.pictures.length},file:image}).success(function(data){$scope.room.pictures.push({provider:"cloudinary",link:data.id}),$scope.busy=!1}).error(function(){$scope.busy=!1,Alert.add("danger","Er was een probleem bij het toevoegen van de afbeelding, probeer later eens opnieuw.",5e3)})}function onDropboxSelect(e,files){$scope.busy=!0,files.forEach(function(file){$http.post("/rooms/"+$scope.room._id+"/upload",{link:file.link,index:$scope.room.pictures.length}).success(function(data){$scope.room.pictures.push({provider:"cloudinary",link:data.id}),$scope.busy=!1}).error(function(){$scope.busy=!1,Alert.add("danger","Er was een probleem bij het toevoegen van de afbeelding, probeer later eens opnieuw.",5e3)})})}function flashSavedText(){$scope.$broadcast("blink_text")}$scope.authentication=Authentication,$scope.createForm={address:"",roomType:""},$scope.autocompleteOptions={country:"be",watchEnter:!0},$scope.addressDetails=null,$scope.busy=!1,$scope.nav="general",$scope.amenities=Amenity.list(),$scope.errors=[],$scope.newAddress="",$scope.newAddressDetails={},$scope.init=function(){Meta.setTitle("Advertentie aanpassen"),$stateParams.nav&&($scope.nav=$stateParams.nav),$stateParams.roomId||$location.path("/"),$scope.room=Rooms.get({roomId:$stateParams.roomId},$scope.watchForUpdates),$scope.$on("dropbox_chosen",onDropboxSelect)},$scope.watchForUpdates=function(){function watchRoomProperties(){return{visible:$scope.room.visible,pictures:$scope.room.pictures,leaseType:$scope.room.leaseType,available:$scope.room.available,loc:$scope.room.loc,location:$scope.room.location,info:$scope.room.info,amenities:$scope.room.amenities,price:$scope.room.price,surface:$scope.room.surface,cohabit:$scope.room.cohabit}}$scope.$broadcast("room_loaded",$scope.room),$scope.checkRoomCompleteness();var updateFunction=$window._.debounce($scope.update,800);$scope.$watch(watchRoomProperties,function(newValue,oldValue){newValue===oldValue||$scope.busy||($scope.checkRoomCompleteness(),updateFunction())},!0)},$scope.update=function(){$scope.room.$update(function(){flashSavedText()},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.onImageSelect=function($files){$files.length>0&&uploadImage($files[0])},$scope.removeImage=function(index){$scope.busy=!0,$http.post("/rooms/"+$scope.room._id+"/removepicture",{index:index}).success(function(){$scope.room.pictures.splice(index,1),$scope.busy=!1}).error(function(){$scope.busy=!1})},$scope.toggleAmenitySelection=function(amenity){var idx=$scope.room.amenities.indexOf(amenity);idx>-1?$scope.room.amenities.splice(idx,1):$scope.room.amenities.push(amenity)},$scope.isAmenityChecked=function(amenity){return $scope.room.amenities?-1!==$scope.room.amenities.indexOf(amenity):!1},$scope.setTab=function(tab){$scope.nav=tab,$location.path("rooms/"+$scope.room._id+"/edit/"+tab)},$scope.checkRoomCompleteness=function(){var errors=[];$scope.room.info.title&&""!==$scope.room.info.title||errors.push("general"),$scope.room.price.base&&0!==$scope.room.price.base||errors.push("costs"),!$scope.room.available.immediately&&(!$scope.room.available.from||!$scope.room.available.till||new Date($scope.room.available.till))<new Date&&errors.push("availability"),console.log(errors),$scope.errors=errors},$scope.tabHasError=function(tab){return-1!==$scope.errors.indexOf(tab)},$scope.openAddressModal=function(){var obj={newAddress:$scope.newAddress,newAddressDetails:$scope.newAddressDetails};Modal.changeAddress(obj).then(function(result){$scope.room.location={street:result.street+" "+result.streetNumber,city:result.city,country:result.country},$scope.room.loc={type:"Point",coordinates:result.geo},$scope.$broadcast("room_loaded",$scope.room)})},$scope.visibilityText=function(item){return item?"online":"offline"},$scope.deleteRoom=function(){Modal.confirm().then(function(){$scope.room.$remove(function(){$location.path("/dashboard/rooms")})})}}]),angular.module("rooms").controller("ModalController",["$rootScope","$scope","$modalInstance","modalContent",function($rootScope,$scope,$modalInstance,modalContent){$scope.modalContent=modalContent}]),angular.module("rooms").controller("RoomsController",["$rootScope","$scope","$stateParams","$http","Authentication","Rooms","Amenity","Modal","Alert","localStorageService","Statistics","Meta","$location","Enforcer",function($rootScope,$scope,$stateParams,$http,Authentication,Rooms,Amenity,Modal,Alert,localStorageService,Statistics,Meta,$location,Enforcer){function sendFavorite(){$http.post("/rooms/"+$scope.room._id+"/favorite").success(function(){var index=Authentication.user.favorites.indexOf($scope.room._id);-1===index?(Statistics.aggregate($scope.room._id,"favorites"),Authentication.user.favorites.push($scope.room._id),Alert.add("success","Toegevoegd aan favorieten!",3e3)):Authentication.user.favorites.splice(index,1)}).error(function(){Alert.add("danger","Er was een probleem bij het toevoegen aan je favorieten, probeer later eens opnieuw.",5e3)})}function sendMessage(message){Statistics.aggregate($scope.room._id,"messages"),$http.post("/rooms/"+$scope.room._id+"/message",{message:message}).success(function(){Alert.add("success","Je bericht is verzonden!",5e3)}).error(function(){Alert.add("danger","Er was een probleem met het verzenden van je bericht, probeer later eens opnieuw.",5e3)})}function sendReservation(extraMessage){Statistics.aggregate($scope.room._id,"reservations"),$http.post("/rooms/"+$scope.room._id+"/message",{message:$scope.appointmentDate.getTime(),messageType:"reservation"}).success(function(){extraMessage?sendMessage(extraMessage):Alert.add("success","Je aanvraag is verzonden!",5e3)}).error(function(){Alert.add("danger","Er was een probleem met het verzenden van je bericht, probeer later eens opnieuw.",5e3)})}function postLoad(){Meta.setTitle($scope.room.info.title+" - "+$scope.room.location.city,!0),Meta.setDescription($scope.room.info.description),Statistics.aggregate($scope.room._id,"views"),$scope.otherRooms=Rooms.getRoomsOfSameLocation({roomId:$scope.room._id}),$scope.$broadcast("room_loaded",$scope.room),0===$scope.room.pictures.length&&$scope.$emit("pictures_rendered")}function loadFailure(){$location.path("/rooms/notfound")}$scope.authentication=Authentication,$scope.contactInfo={appointmentDate:new Date,name:"",email:""},$scope.currentDate=new Date,$scope.appointmentDate=new Date,$scope.otherRooms=[],$scope.amenities=Amenity.list(),$scope.isOverlay=!1,$scope.init=function(){$scope.findOne()},$scope.findOne=function(){$scope.room=Rooms.get({roomId:$stateParams.roomId},postLoad,loadFailure)},$scope.isAmenityChecked=function(room,amenity){return $scope.room.amenities?-1!==room.amenities.indexOf(amenity.value):!1},$scope.openReservationModal=function(){Enforcer.do(function(){Modal.reservation($scope.appointmentDate).then(sendReservation)})},$scope.openContactModal=function(){Enforcer.do(function(){Modal.contact($scope.contactInfo).then(sendMessage)})},$scope.toggleFavorite=function(){Enforcer.do(function(){sendFavorite()})},$scope.isInfavorites=function(){return Authentication.user?-1!==Authentication.user.favorites.indexOf($scope.room._id):!1
},$scope.closeOverlay=function(){$rootScope.$broadcast("close_overlay")},$scope.isOverlay=function(){return $stateParams.isOverlay},$scope.visibilityText=function(item){return item?"online":"offline"},$scope.setVisibility=function(){$http.put("/rooms/"+$scope.room._id,{visible:$scope.room.visible})},$scope.getNumber=function(num){for(var obj=[],i=0;num>i;i++)obj.push(i);return obj}}]),angular.module("rooms").directive("addressLookup",["$window","Geocoder",function($window,Geocoder){return{restrict:"A",scope:{resultObject:"="},require:"^form",link:function(scope,element,attr,form){function geocode(address){Geocoder.geocodeAddress(address).then(function(result){element.val(result.formattedAddress),scope.resultObject={street:result.street,streetNumber:result.streetNumber,city:result.city,country:result.country,geo:[result.lng,result.lat]},checkValidity()})}function getAddressDetails(place){for(var streetNumber="",street="",city="",country="",i=0;i<place.address_components.length;i++){var type=place.address_components[i].types[0];switch(type){case"street_number":streetNumber=place.address_components[i].long_name;break;case"route":street=place.address_components[i].long_name;break;case"locality":city=place.address_components[i].long_name;break;case"country":country=place.address_components[i].long_name}}scope.resultObject={street:street,streetNumber:streetNumber,city:city,country:country,geo:[place.geometry.location.lng(),place.geometry.location.lat()]},checkValidity()}function checkValidity(){scope.resultObject.street&&""!==scope.resultObject.street?form.$setValidity("noStreet",!0):form.$setValidity("noStreet",!1),scope.resultObject.streetNumber&&""!==scope.resultObject.streetNumber?form.$setValidity("noStreetNumber",!0):form.$setValidity("noStreetNumber",!1)}form.$setValidity("",!1);var autocomplete=new $window.google.maps.places.Autocomplete(element[0],{types:["geocode"]});$window.google.maps.event.addListener(autocomplete,"place_changed",function(){var place=autocomplete.getPlace();place.address_components?getAddressDetails(place):geocode(place.name)})}}}]),angular.module("core").directive("blinkText",[function(){return{restrict:"A",link:function(scope,element){scope.$on("blink_text",function(){element.finish().show().fadeOut(1400)})}}}]),angular.module("rooms").directive("owlCarousel",["$window",function($window){return{restrict:"A",link:function(scope,element,attrs){var carousel,defaults={autoPlay:5e3,slideSpeed:200,paginationSpeed:600,rewindSpeed:800,stopOnHover:!0,navigation:!0,pagination:"true"===attrs.owlPagination,rewindNav:!0,singleItem:!0,autoHeight:!1,lazyLoad:!1,mouseDrag:!1,navigationText:['<i class="icon-left-open-mini"></i>','<i class="icon-right-open-mini"></i>']},el=$window.$(element);scope.$on("pictures_rendered",function(){carousel=el.owlCarousel(defaults).data("owlCarousel")}),scope.$on("$destroy",function(){carousel&&carousel.destroy()})}}}]),angular.module("rooms").directive("checkAddress",["$parse",function(){return{restrict:"A",link:function(scope){scope.createRoomForm.$setValidity("input",!1),scope.$watch("autoCompleteDetails",function(newDetails){if(newDetails){scope.createRoomForm.$setValidity("input",!0);for(var streetNumber="",street="",city="",country="",i=0;i<newDetails.address_components.length;i++){var type=newDetails.address_components[i].types[0];switch(type){case"street_number":streetNumber=newDetails.address_components[i].long_name;break;case"route":street=newDetails.address_components[i].long_name;break;case"locality":city=newDetails.address_components[i].long_name;break;case"country":country=newDetails.address_components[i].long_name}}""===street?scope.createRoomForm.$setValidity("noStreet",!1):scope.createRoomForm.$setValidity("noStreet",!0),""===streetNumber?scope.createRoomForm.$setValidity("noStreetNumber",!1):scope.createRoomForm.$setValidity("noStreetNumber",!0),scope.createRoomForm.$valid&&(scope.addressDetails={street:street+" "+streetNumber,city:city,country:country,geo:[newDetails.geometry.location.lng(),newDetails.geometry.location.lat()]})}})}}}]),angular.module("core").directive("dropboxChooser",["$window",function($window){return{restrict:"A",scope:{chooserSuccess:"&"},link:function(scope,element){var options={success:function(files){scope.$emit("dropbox_chosen",files)},linkType:"direct",multiselect:!1,extensions:["images"]};element.click(function(){$window.Dropbox.choose(options)})}}}]),angular.module("core").directive("limitText",[function(){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel"},link:function(scope,element,attributes){scope.$watch("model",function(newValue,oldValue){newValue!==oldValue&&scope.model&&(scope.model=scope.model.substring(0,attributes.limitText))})}}}]),angular.module("rooms").directive("roomMap",["$window",function($window){return{template:'<div id="map" class="map-canvas"></div>',restrict:"A",link:function(scope,element){function getRoomTypeIcon(roomType){return"room"===roomType?"lodging":"appartment"===roomType?"commercial":"building"}var layer=null,map=$window.L.mapbox.map(element[0],"defreek.j27p0821",{zoomControl:!1});scope.$on("room_loaded",function(event,room){map.setView([room.loc.coordinates[1],room.loc.coordinates[0]],15),map.dragging.disable(),map.touchZoom.disable(),map.doubleClickZoom.disable(),map.scrollWheelZoom.disable(),map.tap&&map.tap.disable(),layer&&layer.clearLayers(),layer=$window.L.mapbox.featureLayer({type:"Feature",geometry:room.loc,properties:{"marker-size":"medium","marker-color":"#f44","marker-symbol":getRoomTypeIcon(room.classification)}}).addTo(map)}),scope.$on("$destroy",function(){map.remove()})}}}]),angular.module("rooms").directive("streetView",["$window",function($window){return{scope:{center:"=mapCenter"},template:"<div></div>",restrict:"A",link:function(scope,element){scope.$on("room_loaded",function(event,room){function setStreetViewSettings(streetview,pos,heading){streetview.setPosition(pos),streetview.setPov({heading:heading,zoom:1,pitch:0}),streetview.setVisible(!0)}var coordinates=room.loc.coordinates,position=new $window.google.maps.LatLng(coordinates[1],coordinates[0]),streetview=new $window.google.maps.StreetViewPanorama(element[0],{zoomControl:!1,position:position,pov:{heading:0,pitch:0,zoom:1}}),streetViewService=new $window.google.maps.StreetViewService,streetViewMaxDistance=50;streetViewService.getPanoramaByLocation(position,streetViewMaxDistance,function(streetViewPanoramaData,status){if(status===$window.google.maps.StreetViewStatus.OK){var oldPoint=position;position=streetViewPanoramaData.location.latLng;var heading=$window.google.maps.geometry.spherical.computeHeading(position,oldPoint);setStreetViewSettings(streetview,position,heading)}})})}}}]),angular.module("rooms").factory("Amenity",[function(){return{list:function(){return[{name:"TV",value:"television"},{name:"Internet",value:"internet"},{name:"Terras",value:"terrace"},{name:"Auto garage",value:"parking"},{name:"Fietsstalling",value:"bicycleParking"},{name:"Dubbel glas",value:"doubleGlass"},{name:"Bemeubeld",value:"furnished"},{name:"Aparte badkamer",value:"seperateBathroom"},{name:"Aparte keuken",value:"seperateKitchen"},{name:"Huisdieren toegelaten",value:"pets"},{name:"Domicilie verplicht",value:"domicile"}]}}}]),angular.module("rooms").factory("Rooms",["$resource",function($resource){return $resource("rooms/:roomId",{roomId:"@_id"},{update:{method:"PUT"},getMyRooms:{method:"GET",url:"/myrooms",isArray:!0},getRoomsOfSameLocation:{method:"GET",url:"rooms/:roomId/same",isArray:!0}})}]),angular.module("search").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("search",{url:"/search/:address",templateUrl:"modules/search/views/search.client.view.html"}).state("search.overlay",{url:"/rooms/:roomId/:isOverlay",templateUrl:"modules/rooms/views/view-room.client.view.html"}),$urlRouterProvider.deferIntercept()}]).run(["$rootScope","$urlRouter","$location","$state",function($rootScope,$urlRouter){$rootScope.$on("$locationChangeSuccess",function(e,newUrl,oldUrl){e.preventDefault(),-1!==oldUrl.indexOf("/search/")&&-1!==newUrl.indexOf("/l/")?console.log("skipping route"):$urlRouter.sync(),$urlRouter.listen()})}]),angular.module("search").controller("SearchController",["$rootScope","$scope","$timeout","$location","$state","$stateParams","Geocoder","Rooms","$window","Amenity","Authentication","Users","localStorageService","Meta",function($rootScope,$scope,$timeout,$location,$state,$stateParams,Geocoder,Rooms,$window,Amenity,Authentication,Users,localStorageService,Meta){function parseUrlParameters(urlParamaters){urlParamaters.lat&&urlParamaters.lng&&($scope.filter.location=[parseFloat(urlParamaters.lng),parseFloat(urlParamaters.lat)]),urlParamaters.proximity&&($scope.filter.proximity=urlParamaters.proximity),urlParamaters.minPrice&&($scope.filter.minPrice=+urlParamaters.price),urlParamaters.maxPrice&&($scope.filter.maxPrice=+urlParamaters.maxPrice),urlParamaters.roomType&&($scope.filter.roomType=urlParamaters.roomType),urlParamaters.size&&($scope.filter.size=+urlParamaters.size),urlParamaters.amneties&&($scope.filter.amneties=urlParamaters.amneties)}function doSearchLookup(address){Geocoder.geocodeAddress(address).then(function(result){$scope.mapCenter=[result.lng,result.lat],$scope.filter.proximity=result.proximity})}function closeRoomOverlay(){$state.transitionTo("search",$stateParams,{reload:!1,location:!1}),oldLocation&&($location.url(oldLocation),oldLocation=null),Meta.setTitle("Zoeken in "+$stateParams.address),$scope.selectedRoomId=null,$scope.isOverLayOpen=!1}function showRoomOverlay(){$state.transitionTo("search.overlay",$stateParams,{reload:!1,location:!1}),$scope.$broadcast("close_marker_popups"),$scope.isOverLayOpen=!0}$scope.mapCenter=[4.35171,50.85034],$scope.mapZoom=13,$scope.fetchOnMapChange=!0,$scope.filter={location:[],proximity:3600,roomType:[],minPrice:0,maxPrice:2e3,size:null,amenities:[]},$scope.results=[],$scope.amenities=Amenity.list(),$scope.selectedRoomId=null,$scope.isOverLayOpen=!1;var viewedRooms=localStorageService.get("viewedRooms")||[],oldLocation=null;$scope.init=function(){function getZoomLevel(m){var z=Math.floor(Math.log(20088e3/m)/Math.log(2));return z>19&&(z=19),0>z&&(z=0),z}Meta.setTitle("Zoeken in "+$stateParams.address);var urlParamaters=$location.search();urlParamaters.lat&&urlParamaters.lng||!$stateParams.address?urlParamaters.lat&&urlParamaters.lng?(parseUrlParameters(urlParamaters),$scope.mapCenter=$scope.filter.location,$scope.mapZoom=getZoomLevel($scope.filter.proximity)):$scope.mapZoom=9:doSearchLookup($stateParams.address),$stateParams.roomId&&($scope.selectedRoomId=$stateParams.roomId,showRoomOverlay()),$scope.fetchRooms(),$rootScope.$on("close_overlay",closeRoomOverlay),$scope.$watch("filter",function(newValue,oldValue){newValue!==oldValue&&$scope.searchFunction()},!0)},$scope.mapChangedEvent=function(result){$scope.filter.proximity=result.proximity/2,$scope.filter.location=[result.lng,result.lat],$location.search("lat",result.lat).search("lng",result.lng).search("proximity",$scope.filter.proximity),$timeout(function(){$scope.$apply()})},$scope.fetchRooms=function(){Rooms.query($scope.filter,function(results){var oldRooms=$scope.results,newRooms=results,oldIds=oldRooms.map(function(room){return room._id}),newIds=newRooms.map(function(room){return room._id}),toDelete=$window._.difference(oldIds,newIds),toAdd=$window._.difference(newIds,oldIds);oldRooms=oldRooms.filter(function(room){return!$window._.contains(toDelete,room._id)}),newRooms.forEach(function(room){$window._.contains(toAdd,room._id)&&oldRooms.push(room)}),$scope.results=oldRooms})},$scope.toggleAmenitySelection=function(amenity){var idx=$scope.filter.amenities.indexOf(amenity);idx>-1?$scope.filter.amenities.splice(idx,1):$scope.filter.amenities.push(amenity)},$scope.saveQueryAsUserAlert=function(){if(Authentication.user){var query=angular.copy($scope.filter);Authentication.user.alerts.push({filters:query});var user=new Users(Authentication.user);user.$update()}},$scope.selectRoom=function(roomId,url){if($scope.selectedRoomId&&$scope.selectedRoomId===roomId)$scope.selectedRoomId=null,closeRoomOverlay();else{$scope.selectedRoomId=roomId,$window._.extend($stateParams,{roomId:roomId,isOverlay:!0});var currentUrl=$location.url();-1!==currentUrl.indexOf("/search")&&(oldLocation=$location.url(),$location.url(url)),showRoomOverlay(),-1===viewedRooms.indexOf(roomId)&&viewedRooms.push(roomId)}},$scope.hasSeenRoom=function(roomId){return-1!==viewedRooms.indexOf(roomId)},$scope.openRoomPopup=function(roomId){$scope.$broadcast("open_marker_popup",roomId)},$scope.getRoomTypeIcon=function(roomType){return"room"===roomType?"lodging":"appartment"===roomType?"commercial":"building"},$scope.setRoomType=function(selection){return"all"===selection?[]:[selection]},$scope.searchFunction=$window._.debounce($scope.fetchRooms,400)}]),angular.module("search").directive("checkboxGroup",["$window",function($window){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel"},link:function(scope,element){var buttons=element.children("button");buttons.bind("click",function(e){var el=$window.$(e.currentTarget),val=el.attr("data-val"),index=scope.model.indexOf(val);el.hasClass("active")?(-1!==index&&scope.model.splice(index,1),el.removeClass("active")):(-1===index&&scope.model.push(val),el.addClass("active")),e.stopPropagation()})}}}]),angular.module("search").directive("googleMap",["$window",function($window){return{scope:{markers:"=mapMarkers",center:"=mapCenter",zoom:"=mapZoom",options:"=mapOptions",changedEvent:"=mapChanged"},template:'<div id="map" class="map-canvas"></div>',restrict:"A",link:function(scope,element){function calculateProximity(){var bounds=map.getBounds(),swPoint=bounds.getSouthWest(),nePoint=bounds.getNorthEast();return $window.google.maps.geometry.spherical.computeDistanceBetween(swPoint,nePoint)}function clearMarkers(){markers.forEach(function(marker){marker.setMap(null)}),markers=[]}var markers=[],mapOptions={center:new $window.google.maps.LatLng(scope.center[1],scope.center[0]),zoom:scope.zoom,disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{style:$window.google.maps.ZoomControlStyle.SMALL},mapTypeId:$window.google.maps.MapTypeId.ROADMAP},map=new $window.google.maps.Map(element[0],mapOptions);scope.changedEvent&&(map.addListener("dragend",function(){scope.changedEvent({lng:map.getCenter().lng(),lat:map.getCenter().lat(),proximity:calculateProximity()})}),map.addListener("zoom_changed",function(){scope.changedEvent({lng:map.getCenter().lng(),lat:map.getCenter().lat(),proximity:calculateProximity()})})),scope.$watchCollection("markers",function(newValues,oldValues){newValues!==oldValues&&(clearMarkers(),newValues.forEach(function(value){var marker=new $window.google.maps.Marker({map:map,position:new $window.google.maps.LatLng(value.loc.coordinates[1],value.loc.coordinates[0]),icon:new $window.google.maps.MarkerImage("/modules/rooms/img/map-marker2.svg")});markers.push(marker)}))}),scope.$watch("center",function(newValue,oldValue){newValue!==oldValue&&map.setCenter(new $window.google.maps.LatLng(newValue[1],newValue[0]))}),scope.$watch("zoom",function(newValue,oldValue){newValue!==oldValue&&map.setZoom(newValue)})}}}]),angular.module("search").directive("mapboxMap",["$compile","$q","$window","$http","$timeout",function($compile,$q,$window,$http,$timeout){var _mapboxMap;return{restrict:"E",transclude:!0,replace:!0,scope:{center:"=mapCenter",zoom:"=mapZoom",changedEvent:"=mapChanged",preventPopups:"=",selectRoom:"="},template:'<div class="map-canvas" ng-transclude></div>',link:function(scope,element,attrs){function openMarkerPopupById(roomId){scope.markers.forEach(function(marker){marker.roomId===roomId&&marker.openPopup()})}function getBoundsDistance(){var bounds=scope.map.getBounds(),northWest=bounds.getNorthWest(),southEast=bounds.getSouthEast();return Math.floor(northWest.distanceTo(southEast))}function getFoursquareData(){var center=scope.map.getCenter(),params={client_id:"4I5SHYQHG4OXY2ZCCRTFPNYFVK0U0G4NPLIBKLWGM2SWLPVY",client_secret:"11YEGLXWQBXX4KERSY2CXLMC4E3C2X021DGZLXVVMK0KRWJZ",ll:center.lat+","+center.lng,radius:getBoundsDistance(),v:"20140701",categoryId:"4bf58dd8d48988d1ae941735"};$http({url:"https://api.foursquare.com/v2/venues/search",method:"GET",params:params}).success(function(result){result.response.venues.forEach(function(venue){{var latlng=$window.L.latLng(venue.location.lat,venue.location.lng);$window.L.marker(latlng,{icon:$window.L.divIcon({className:"maki-icon college"})}).bindPopup('<a target="_blank" href="https://foursquare.com/v/'+venue.id+'">'+venue.name+"</a>").addTo(foursquareMarkers)}})})}scope.map=$window.L.mapbox.map(element[0],"defreek.j27p0821").setView([scope.center[1],scope.center[0]],scope.zoom),_mapboxMap.resolve(scope.map),scope.isClusteringMarkers=void 0!==attrs.clusterMarkers;var shouldRefitMap=void 0!==attrs.scaleToFit;scope.fitMapToMarkers=function(){if(shouldRefitMap){var group=new $window.L.featureGroup(scope.markers);scope.map.fitBounds(group.getBounds())}};var foursquareMarkers=(new $window.L.featureGroup).addTo(scope.map);scope.changedEvent&&scope.map.on("moveend",function(){var center=scope.map.getCenter();scope.changedEvent({lng:center.lng,lat:center.lat,proximity:getBoundsDistance()})}),scope.$on("open_marker_popup",function(event,id){scope.preventPopups||openMarkerPopupById(id)}),scope.$on("close_marker_popups",function(){scope.markers.forEach(function(marker){marker.closePopup()})}),scope.map.on("popupopen",function(){var popup=angular.element(document.getElementsByClassName("leaflet-popup-content"));$compile(popup)(scope),$timeout(function(){scope.$apply()})}),scope.$on("$destroy",function(){scope.map.remove()}),getFoursquareData()},controller:function($scope){$scope.markers=[],$scope.featureLayers=[],_mapboxMap=$q.defer(),$scope.getMap=this.getMap=function(){return _mapboxMap.promise},$window.L.MarkerClusterGroup&&($scope.clusterGroup=new $window.L.MarkerClusterGroup({showCoverageOnHover:!1}),this.getMap().then(function(map){map.addLayer($scope.clusterGroup)})),this.$scope=$scope}}}]),angular.module("search").directive("mapboxMarker",["$compile","$window","$http",function($compile,$window){var _colors={navy:"#001f3f",blue:"#0074d9",aqua:"#7fdbff",teal:"#39cccc",olive:"#3d9970",green:"#2ecc40",lime:"#01ff70",yellow:"#ffdc00",orange:"#ff851b",red:"#ff4136",fuchsia:"#f012be",purple:"#b10dc9",maroon:"#85144b",white:"white",silver:"#dddddd",gray:"#aaaaaa",black:"#111111"};return{restrict:"E",require:"^mapboxMap",transclude:!0,scope:!0,replace:!0,link:function(scope,element,attrs,controller,transclude){function setStyleOptions(attrs,default_opts){var opts=default_opts||{};return attrs.size&&(opts["marker-size"]=attrs.size),attrs.color&&(opts["marker-color"]="#"===attrs.color[0]?attrs.color:_colors[attrs.color]||attrs.color),attrs.icon&&(opts["marker-symbol"]=attrs.icon),opts}var marker,opts={draggable:void 0!==attrs.draggable},style=setStyleOptions(attrs),addMarker=function(map,attrs,popupContent,opts,style){opts=opts||{};var marker=$window.L.mapbox.marker.style({properties:style},[attrs.lat,attrs.lng]);return popupContent&&popupContent.length>0&&(marker.bindPopup(popupContent,{closeButton:!1,minWidth:320}),marker.roomId=attrs.roomId),controller.$scope.isClusteringMarkers&&opts.excludeFromClustering!==!0?controller.$scope.clusterGroup.addLayer(marker):marker.addTo(map),opts.draggable&&marker.dragging.enable(),controller.$scope.markers.push(marker),marker},addCurrentLocation=function(map,popupContent,opts,style){style=setStyleOptions(style,{"marker-color":"#000","marker-symbol":"star"}),opts.excludeFromClustering=!0,map.on("locationfound",function(e){marker=addMarker(map,[e.latlng.lat,e.latlng.lng],null,opts,style)}),map.locate()};controller.getMap().then(function(map){setTimeout(function(){for(var popupHTML="",transcluded=transclude(scope,function(){}),i=0;i<transcluded.length;i++)void 0!==transcluded[i].outerHTML&&(popupHTML+=transcluded[i].outerHTML);if(void 0!==attrs.currentLocation)addCurrentLocation(map,null,opts,style);else{if(popupHTML){var popup=angular.element(popupHTML);$compile(popup)(scope),scope.$$phase||scope.$digest();var newPopupHTML="";for(i=0;i<popup.length;i++)newPopupHTML+=popup[i].outerHTML;marker=addMarker(map,attrs,newPopupHTML,opts,style)}else marker=addMarker(map,attrs,null,opts,style);element.bind("$destroy",function(){controller.$scope.isClusteringMarkers?controller.$scope.clusterGroup.removeLayer(marker):map.removeLayer(marker)})}},0)})}}}]),angular.module("search").directive("radioGroup",["$window","$timeout",function($window,$timeout){return{require:"ngModel",restrict:"A",scope:{model:"=ngModel",outputFunction:"="},link:function(scope,element){function setModel(data){scope.model=scope.outputFunction?scope.outputFunction(data):data,$timeout(function(){scope.$apply()})}var buttons=element.children("button"),active=element.children("button.active");setModel(active.attr("data-val")),buttons.bind("click",function(e){var el=$window.$(e.currentTarget);el.hasClass("active")||(buttons.removeClass("active"),el.addClass("active")),setModel(el.attr("data-val")),e.stopPropagation()})}}}]),angular.module("search").directive("rangeSlidera",["$window",function($window){return{restrict:"A",scope:{start:"@",step:"@",end:"@",callback:"@",margin:"@",ngModel:"=",ngFrom:"=",ngTo:"="},link:function(scope,element){var callback,fromParsed,parsedValue,slider,toParsed;return slider=$window.$(element),callback=scope.callback?scope.callback:"slide",null!==scope.ngFrom&&null!==scope.ngTo?(fromParsed=null,toParsed=null,slider.noUiSlider({start:[scope.ngFrom||scope.start,scope.ngTo||scope.end],step:parseFloat(scope.step||1),connect:!0,margin:parseFloat(scope.margin||0),range:{min:[parseFloat(scope.start)],max:[parseFloat(scope.end)]}}),slider.on(callback,function(){var _ref=slider.val(),from=_ref[0],to=_ref[1];return fromParsed=parseFloat(from),toParsed=parseFloat(to),scope.$apply(function(){return scope.ngFrom=fromParsed,scope.ngTo=toParsed,toParsed})}),scope.$watch("ngFrom",function(newVal){return newVal!==fromParsed?slider.val([newVal,null]):void 0}),scope.$watch("ngTo",function(newVal){return newVal!==toParsed?slider.val([null,newVal]):void 0})):(parsedValue=null,slider.noUiSlider({start:[scope.ngModel||scope.start],step:parseFloat(scope.step||1),range:{min:[parseFloat(scope.start)],max:[parseFloat(scope.end)]}}),slider.on(callback,function(){return parsedValue=parseFloat(slider.val()),scope.$apply(function(){return scope.ngModel=parsedValue,parsedValue})}),scope.$watch("ngModel",function(newVal){return newVal!==parsedValue?slider.val(newVal):void 0}))}}}]),angular.module("core").factory("Geocoder",["localStorageService","$q","$timeout","$rootScope",function($localStorage,$q,$timeout,$rootScope){var locations=$localStorage.get("locations")?$localStorage.get("locations"):{},queue=[],QUERY_PAUSE=250,executeNext=function(){var task=queue[0],geocoder=new google.maps.Geocoder;geocoder.geocode({address:task.address},function(result,status){if(status===google.maps.GeocoderStatus.OK){for(var parsedResult={lat:result[0].geometry.location.lat(),lng:result[0].geometry.location.lng(),formattedAddress:result[0].formatted_address,accuracy:result[0].address_components.length},i=0;i<result[0].address_components.length;i++){var type=result[0].address_components[i].types[0];switch(type){case"street_number":parsedResult.streetNumber=result[0].address_components[i].long_name;break;case"route":parsedResult.street=result[0].address_components[i].long_name;break;case"locality":parsedResult.city=result[0].address_components[i].long_name;break;case"country":parsedResult.country=result[0].address_components[i].long_name}}locations[task.address]=parsedResult,$localStorage.set("locations",locations),queue.shift(),task.d.resolve(parsedResult)}else status===google.maps.GeocoderStatus.ZERO_RESULTS?(queue.shift(),task.d.reject({type:"zero",message:"Zero results for geocoding address "+task.address})):status===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?task.executedAfterPause&&(queue.shift(),task.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+task.address})):status===google.maps.GeocoderStatus.REQUEST_DENIED?(queue.shift(),task.d.reject({type:"denied",message:"Request denied for geocoding address "+task.address})):(queue.shift(),task.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+status+", address="+task.address}));if(queue.length)if(status===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var nextTask=queue[0];nextTask.executedAfterPause=!0,$timeout(executeNext,QUERY_PAUSE)}else $timeout(executeNext,0);$rootScope.$$phase||$rootScope.$apply()})};return{geocodeAddress:function(address){var d=$q.defer();return _.has(locations,address)?d.resolve(locations[address]):(queue.push({address:address,d:d}),1===queue.length&&executeNext()),d.promise}}}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/signin.client.view.html"}).state("forgot",{url:"/forgot",templateUrl:"modules/users/views/forgot.client.view.html"}).state("reset",{url:"/reset/:token",templateUrl:"modules/users/views/reset.client.view.html"}).state("dashboard",{url:"/dashboard/:nav",templateUrl:"modules/users/views/dashboard.client.view.html"}).state("viewInbox",{url:"/dashboard/messages/:inboxId",templateUrl:"modules/users/views/inbox.client.view.html",reloadOnSearch:!1}).state("favorites",{url:"/users/:userId/favorites",templateUrl:"modules/users/views/favorites.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$stateParams","$http","$location","$q","Authentication","Modal",function($scope,$stateParams,$http,$location,$q,Authentication,Modal){$scope.authentication=Authentication,$scope.busy=!1,$scope.authentication.user&&$location.path("/"),$scope.signup=function(redirectTo){var deferred=$q.defer();$scope.busy=!0,$http.post("/auth/signup",$scope.credentials).success(function(response){return $scope.authentication.user=response,$scope.$close&&$scope.$close(),$location.path(redirectTo||"/"),deferred.resolve(),$scope.busy=!1,deferred.promise}).error(function(response){return $scope.error=response.message,deferred.reject(),$scope.busy=!1,deferred.promise})},$scope.signin=function(redirectTo){var deferred=$q.defer();$scope.busy=!0,$http.post("/auth/signin",$scope.credentials).success(function(response){return $scope.authentication.user=response,$scope.$close&&$scope.$close(),$location.path(redirectTo||"/"),deferred.resolve(),$scope.busy=!1,deferred.promise}).error(function(response){return $scope.error=response.message,deferred.reject(),$scope.busy=!1,deferred.promise})},$scope.forgot=function(){$scope.success=$scope.error=null,$scope.busy=!0,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message,$scope.busy=!1}).error(function(response){$scope.credentials=null,$scope.error=response.message,$scope.busy=!1})},$scope.reset=function(){$scope.success=$scope.error=null,$scope.busy=!0,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.success=response.message,$scope.passwordDetails=null,$scope.busy=!1}).error(function(response){$scope.error=response.message,$scope.busy=!1})},$scope.openSignupModal=function(){$scope.$dismiss&&$scope.$dismiss(),Modal.signup()},$scope.openSigninModal=function(){$scope.$dismiss&&$scope.$dismiss(),Modal.signin()}}]),angular.module("users").controller("DashboardController",["$scope","$stateParams","$location","Rooms","Authentication","Meta",function($scope,$stateParams,$location,Rooms,Authentication,Meta){$scope.authentication=Authentication,$scope.nav="rooms",$scope.init=function(){Meta.setTitle("Dashboard"),$stateParams.nav&&($scope.nav=$stateParams.nav)},$scope.getMyRooms=function(){$scope.myrooms=Rooms.getMyRooms()},$scope.setTab=function(tab){$scope.nav=tab,$location.path("dashboard/"+tab)},$scope.goToRoom=function(roomId){$location.path("rooms/"+roomId)},$scope.visibilityText=function(item){return item?"online":"offline"},$scope.updateRoom=function(room){room.$update()}}]),angular.module("users").controller("FavoritesController",["$scope","$http","$location","$stateParams","Authentication","Meta",function($scope,$http,$location,$stateParams,Authentication,Meta){function getUserFavorites(){$http.get("/users/"+$scope.user._id+"/favorites").success(function(response){$scope.favorites=response,$scope.busy=!1}).error(function(){$scope.busy=!1})}$scope.authentication=Authentication,$scope.favorites=[],$scope.busy=!1,$scope.init=function(){$http.get("/users/"+$stateParams.userId).success(function(response){$scope.user=response,Meta.setTitle("Wishlist van "+$scope.user.displayName),getUserFavorites()})}}]),angular.module("users").controller("InboxController",["$rootScope","$scope","$location","$http","$stateParams","Inbox","Authentication","Socket",function($rootScope,$scope,$location,$http,$stateParams,Inbox,Authentication,Socket){function setInboxAsRead(inbox){inbox.messages.forEach(function(message){message.sender!==Authentication.user._id&&(message.isRead=!0)}),inbox.$update()}$scope.authentication=Authentication,$scope.newMessage="",$scope.busy=!1,$scope.init=function(){$scope.findOne($stateParams.inboxId),$scope.inbox.$promise.then(function(inbox){Socket.emit("join",inbox._id)}),$scope.$on("$destroy",function(){Socket.emit("leave",$scope.inbox._id)}),Socket.on("newMessage",function(message){$scope.inbox.messages.push(message)})},$scope.list=function(){$scope.inboxes=Inbox.query()},$scope.findOne=function(inboxId){$scope.inboxes=Inbox.query(),$scope.inbox=Inbox.get({inboxId:inboxId},function(inbox){$scope.hasUnreadMessages(inbox)&&(setInboxAsRead(inbox),$rootScope.$broadcast("inbox_read"))})},$scope.sendMessage=function(){$scope.newMessage&&""!==$scope.newMessage&&($scope.busy=!0,$http.post("/inbox/"+$scope.inbox._id+"/sendmessage",{message:$scope.newMessage}).success(function(response){$scope.busy=!1,$scope.newMessage="",$scope.inbox=response}).error(function(){$scope.busy=!1}))},$scope.isMessageOwner=function(message){return message.sender===Authentication.user._id},$scope.showInbox=function(inboxId){$scope.findOne(inboxId),$location.path("dashboard/messages/"+inboxId)},$scope.getUserPicture=function(inbox){var user=inbox.sender._id===Authentication.user._id?inbox.roomOwner:inbox.sender,pictureSrc="";return"local"===user.provider?pictureSrc="/modules/core/img/default-user-icon.png":"google"===user.provider?pictureSrc=user.providerData.picture:"facebook"===user.provider&&(pictureSrc="http://graph.facebook.com/"+user.providerData.id+"/picture?type=normal"),{"background-image":"url("+pictureSrc+")"}},$scope.getLastMessage=function(inbox){return inbox.messages[inbox.messages.length-1]},$scope.hasUnreadMessages=function(inbox){for(var i=0;i<inbox.messages.length;i++){var message=inbox.messages[i];if(message.sender!==Authentication.user._id&&!message.isRead)return!0}return!1}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","$stateParams","Users","Authentication",function($scope,$http,$location,$stateParams,Users,Authentication){$scope.user=Authentication.user,$scope.busy=!1,$scope.nav="info",$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(){for(var i in $scope.user.additionalProvidersData)return!0;
return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http.delete("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})},$scope.getSubscription=function(){var plan=Authentication.user.subscriptionPlan;return"FREE"===plan?"Student":"PRO"===plan?"Huisbaas":"BUSINESS"===plan?"Agentschap":void 0}}]),angular.module("users").directive("scrollBottom",["$timeout",function($timeout){return{require:"ngModel",scope:{model:"=ngModel"},restrict:"A",link:function(scope,$el){function scrollToBottom(){el.scrollTop=el.scrollHeight}var el=$el[0];scope.$parent.$on("messages_rendered",function(){$timeout(function(){scrollToBottom()},100)}),scope.$watch("model",function(newValue){newValue&&scrollToBottom()})}}}]),angular.module("core").directive("userPicture",[function(){return{restriction:"A",scope:{userModel:"="},link:function(scope,element){function getUserPicture(user){return"google"===user.provider?user.providerData.picture:"facebook"===user.provider?"http://graph.facebook.com/"+user.providerData.id+"/picture?type=normal":"/modules/core/img/default-user-icon.png"}scope.$watch("userModel",function(newVal){newVal&&element.css({"background-image":"url("+getUserPicture(newVal)+")"})})}}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").service("Enforcer",["Authentication","Modal",function(Authentication,Modal){this.do=function(callback){Authentication.user?callback():Modal.signup().then(callback)}}]),angular.module("users").factory("Inbox",["$resource",function($resource){return $resource("inbox/:inboxId",{inboxId:"@_id"},{update:{method:"PUT"},sendMessage:{method:"POST",url:"inbox/:inboxId/sendmessage"}})}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);